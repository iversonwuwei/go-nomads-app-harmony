import { City, CityHelper } from '../../models/City';
import { Meetup, MeetupHelper, MeetupStatus } from '../../models/Meetup';
import { HttpService } from '../../services/HttpService';
import { ApiConfig } from '../../common/constants/ApiConfig';
import { AppColors } from '../../common/constants/AppColors';
import { RouteConstants } from '../../common/constants/RouteConstants';
import { AppStorageKeys } from '../../common/constants/AppStorageKeys';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'HomeTab';
const DOMAIN = 0x0001;

/**
 * é¦–é¡µ Tab å†…å®¹ - å¯¹åº” Flutter ç«¯ HomePage
 * åŒ…å« Hero åŒºåŸŸã€æœç´¢æ ã€åŸå¸‚ç½‘æ ¼ã€èšä¼šåˆ—è¡¨ç­‰
 */
@Component
export struct HomeTab {
  @State cities: City[] = [];
  @State meetups: Meetup[] = [];
  @State isLoading: boolean = true;
  @State searchQuery: string = '';
  @StorageProp(AppStorageKeys.IS_AUTHENTICATED) isAuthenticated: boolean = false;

  aboutToAppear(): void {
    this.loadData();
  }

  async loadData(): Promise<void> {
    this.isLoading = true;
    try {
      const httpService = HttpService.getInstance();

      // å¹¶è¡ŒåŠ è½½åŸå¸‚å’Œèšä¼šæ•°æ®
      const citiesPromise = httpService.get<City[]>(ApiConfig.CITY_LIST_ENDPOINT, {
        queryParams: { 'pageSize': '12', 'page': '1' },
      });
      const meetupsPromise = httpService.get<Meetup[]>(ApiConfig.MEETUPS_ENDPOINT, {
        queryParams: { 'pageSize': '5', 'status': 'published' },
      });

      const results = await Promise.all<Object>([
        citiesPromise.catch((): City[] => []),
        meetupsPromise.catch((): Meetup[] => []),
      ]);

      const cities = results[0] as City[];
      const meetups = results[1] as Meetup[];

      this.cities = cities;
      this.meetups = meetups;
      hilog.info(DOMAIN, TAG, 'âœ… é¦–é¡µæ•°æ®åŠ è½½å®Œæˆ: %{public}d åŸå¸‚, %{public}d èšä¼š',
        cities.length, meetups.length);
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ é¦–é¡µæ•°æ®åŠ è½½å¤±è´¥: %{public}s', JSON.stringify(err));
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // Hero åŒºåŸŸ
        this.HeroSection()

        // æœç´¢æ 
        this.SearchBar()

        // å¿«é€Ÿå…¥å£
        this.QuickEntrySection()

        // AI Chat å…¥å£
        this.AiEntryCard()

        // æ¨èåŸå¸‚
        this.CitiesSection()

        // è¿‘æœŸèšä¼š
        this.MeetupsSection()

        // åº•éƒ¨é—´è·
        Column().height(80)
      }
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  // ============================================================
  // Hero åŒºåŸŸ - æ·±è‰²èƒŒæ™¯ + Logo + å‰¯æ ‡é¢˜
  // ============================================================
  @Builder
  HeroSection() {
    Column() {
      // Logo
      Row({ space: 12 }) {
        Text('ğŸŒ')
          .fontSize(32)
        Text('è¡Œé€” GO-NOMADS')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
      }
      .margin({ top: 60 })

      // å‰¯æ ‡é¢˜
      Text('åŠ å…¥å…¨çƒæ•°å­—æ¸¸æ°‘ç¤¾åŒº\næ¢ç´¢ä¸–ç•Œï¼Œè‡ªç”±å·¥ä½œ')
        .fontSize(16)
        .fontColor('#FFFFFFCC')
        .textAlign(TextAlign.Center)
        .lineHeight(24)
        .margin({ top: 16, bottom: 32 })
    }
    .width('100%')
    .padding({ left: 24, right: 24, top: 20, bottom: 32 })
    .linearGradient({
      direction: GradientDirection.Top,
      colors: [['#1a1a2e', 0.0], ['#16213e', 1.0]],
    })
  }

  // ============================================================
  // æœç´¢æ 
  // ============================================================
  @Builder
  SearchBar() {
    Row() {
      SymbolGlyph($r('sys.symbol.magnifyingglass'))
        .fontSize(20)
        .fontColor([AppColors.TEXT_TERTIARY])

      TextInput({ placeholder: 'æœç´¢åŸå¸‚ã€å›½å®¶...', text: this.searchQuery })
        .layoutWeight(1)
        .backgroundColor('transparent')
        .borderRadius(0)
        .height(40)
        .onChange((value: string) => {
          this.searchQuery = value;
        })
        .onSubmit(() => {
          if (this.searchQuery) {
            router.pushUrl({
              url: `pages/${RouteConstants.CITY_SEARCH}`,
              params: { query: this.searchQuery },
            });
          }
        })
    }
    .width('100%')
    .height(48)
    .borderRadius(24)
    .backgroundColor('#F1F5F9')
    .padding({ left: 16, right: 16 })
    .margin({ left: 16, right: 16, top: 16, bottom: 8 })
  }

  // ============================================================
  // å¿«é€Ÿå…¥å£ï¼ˆåŸå¸‚åˆ—è¡¨ã€å…¨çƒåœ°å›¾ã€AIèŠå¤©ã€æ”¶è—ï¼‰
  // ============================================================
  @Builder
  QuickEntrySection() {
    Row() {
      this.QuickEntryItem('ğŸ™ï¸', 'åŸå¸‚', () => {
        // åˆ‡æ¢åˆ°åŸå¸‚åˆ—è¡¨ Tab
        AppStorage.set(AppStorageKeys.CURRENT_TAB_INDEX, 1);
      })
      this.QuickEntryItem('ğŸ—ºï¸', 'åœ°å›¾', () => {
        router.pushUrl({ url: `pages/${RouteConstants.GLOBAL_MAP}` });
      })
      this.QuickEntryItem('ğŸ¤–', 'AIåŠ©æ‰‹', () => {
        router.pushUrl({ url: `pages/${RouteConstants.AI_CHAT}` });
      })
      this.QuickEntryItem('â¤ï¸', 'æ”¶è—', () => {
        router.pushUrl({ url: `pages/${RouteConstants.FAVORITES}` });
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .padding({ top: 12, bottom: 12 })
  }

  @Builder
  QuickEntryItem(icon: string, label: string, onClick: () => void) {
    Column({ space: 6 }) {
      Text(icon)
        .fontSize(28)
      Text(label)
        .fontSize(12)
        .fontColor(AppColors.TEXT_SECONDARY)
    }
    .onClick(onClick)
    .padding(8)
  }

  // ============================================================
  // AI Chat å…¥å£å¡ç‰‡
  // ============================================================
  @Builder
  AiEntryCard() {
    Row() {
      Column({ space: 4 }) {
        Text('AI æ—…è¡ŒåŠ©æ‰‹')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Text('è®© AI å¸®ä½ è§„åˆ’ä¸‹ä¸€æ®µæ—…ç¨‹')
          .fontSize(13)
          .fontColor('#FFFFFFCC')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Text('ğŸ’¬')
        .fontSize(32)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 8, bottom: 8 })
    .borderRadius(12)
    .linearGradient({
      direction: GradientDirection.Right,
      colors: [[AppColors.PRIMARY, 0.0], [AppColors.PRIMARY_DARK, 1.0]],
    })
    .onClick(() => {
      router.pushUrl({ url: `pages/${RouteConstants.AI_CHAT}` });
    })
  }

  // ============================================================
  // æ¨èåŸå¸‚ç½‘æ ¼
  // ============================================================
  @Builder
  CitiesSection() {
    Column() {
      // æ ‡é¢˜è¡Œ
      Row() {
        Text('æ¨èåŸå¸‚')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)
        Blank()
        Text('æŸ¥çœ‹å…¨éƒ¨ â†’')
          .fontSize(14)
          .fontColor(AppColors.PRIMARY)
          .onClick(() => {
            AppStorage.set(AppStorageKeys.CURRENT_TAB_INDEX, 1);
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })

      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 20, bottom: 20 })
      } else if (this.cities.length === 0) {
        Text('æš‚æ— åŸå¸‚æ•°æ®')
          .fontSize(14)
          .fontColor(AppColors.TEXT_TERTIARY)
          .margin({ top: 20, bottom: 20 })
      } else {
        // åŸå¸‚ç½‘æ ¼ 2åˆ—
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
          ForEach(this.cities.slice(0, 6), (city: City) => {
            this.CityCard(city)
          }, (city: City) => city.id)
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }
    }
  }

  @Builder
  CityCard(city: City) {
    Column() {
      // åŸå¸‚å›¾ç‰‡
      Stack() {
        Image(CityHelper.landscapeImageUrl(city) || $r('app.media.startIcon'))
          .width('100%')
          .height(120)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 10, topRight: 10 })

        // è¯„åˆ†æ ‡ç­¾
        if (city.overallScore && city.overallScore > 0) {
          Text(`â­ ${city.overallScore.toFixed(1)}`)
            .fontSize(11)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000066')
            .borderRadius(10)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .position({ x: 8, y: 8 })
        }
      }
      .width('100%')

      // åŸå¸‚ä¿¡æ¯
      Column({ space: 4 }) {
        Text(CityHelper.displayName(city))
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(city.country ?? '')
          .fontSize(12)
          .fontColor(AppColors.TEXT_SECONDARY)
          .maxLines(1)

        // æ ‡ç­¾
        Row({ space: 4 }) {
          if (city.temperature !== undefined) {
            Text(`ğŸŒ¡ï¸ ${city.temperature}Â°C`)
              .fontSize(11)
              .fontColor(AppColors.TEXT_TERTIARY)
          }
          if (city.meetupCount && city.meetupCount > 0) {
            Text(`ğŸ‘¥ ${city.meetupCount}`)
              .fontSize(11)
              .fontColor(AppColors.TEXT_TERTIARY)
          }
        }
      }
      .width('100%')
      .padding({ left: 8, right: 8, top: 8, bottom: 10 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('48%')
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .borderRadius(10)
    .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
    .margin({ bottom: 12 })
    .onClick(() => {
      router.pushUrl({
        url: `pages/${RouteConstants.CITY_DETAIL}`,
        params: { cityId: city.id, cityName: city.name },
      });
    })
  }

  // ============================================================
  // è¿‘æœŸèšä¼š
  // ============================================================
  @Builder
  MeetupsSection() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('è¿‘æœŸèšä¼š')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)
        Blank()
        Text('æŸ¥çœ‹å…¨éƒ¨ â†’')
          .fontSize(14)
          .fontColor(AppColors.PRIMARY)
          .onClick(() => {
            AppStorage.set(AppStorageKeys.CURRENT_TAB_INDEX, 2);
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 24, bottom: 12 })

      if (this.meetups.length === 0 && !this.isLoading) {
        Text('æš‚æ— è¿‘æœŸèšä¼š')
          .fontSize(14)
          .fontColor(AppColors.TEXT_TERTIARY)
          .margin({ top: 12, bottom: 12 })
      } else {
        ForEach(this.meetups.slice(0, 3), (meetup: Meetup) => {
          this.MeetupCard(meetup)
        }, (meetup: Meetup) => meetup.id)
      }
    }
  }

  @Builder
  MeetupCard(meetup: Meetup) {
    Row() {
      // å·¦ä¾§æ—¥æœŸ
      Column({ space: 2 }) {
        Text(new Date(meetup.schedule.startTime).getDate().toString())
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.PRIMARY)
        Text(new Date(meetup.schedule.startTime).toLocaleDateString('zh-CN', { month: 'short' }))
          .fontSize(12)
          .fontColor(AppColors.TEXT_SECONDARY)
      }
      .width(56)
      .justifyContent(FlexAlign.Center)

      // å³ä¾§ä¿¡æ¯
      Column({ space: 4 }) {
        Text(meetup.title)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor(AppColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(meetup.venue.name)
          .fontSize(13)
          .fontColor(AppColors.TEXT_SECONDARY)
          .maxLines(1)

        Row({ space: 8 }) {
          Text(`ğŸ‘¥ ${meetup.capacity.current}${meetup.capacity.max ? '/' + meetup.capacity.max : ''}`)
            .fontSize(12)
            .fontColor(AppColors.TEXT_TERTIARY)

          if (MeetupHelper.isStartingSoon(meetup)) {
            Text('å³å°†å¼€å§‹')
              .fontSize(11)
              .fontColor('#FFFFFF')
              .backgroundColor(AppColors.WARNING)
              .borderRadius(4)
              .padding({ left: 6, right: 6, top: 1, bottom: 1 })
          }
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .padding({ left: 12 })
    }
    .width('100%')
    .padding(12)
    .margin({ left: 16, right: 16, bottom: 8 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .borderRadius(10)
    .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 1 })
    .onClick(() => {
      router.pushUrl({
        url: `pages/${RouteConstants.MEETUP_DETAIL}`,
        params: { meetupId: meetup.id },
      });
    })
  }
}
