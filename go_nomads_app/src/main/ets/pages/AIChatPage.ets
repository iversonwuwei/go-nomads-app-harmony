import { AppColors } from '../common/constants/AppColors';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { HttpService } from '../services/HttpService';
import { ApiConfig } from '../common/constants/ApiConfig';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'AIChatPage';
const DOMAIN = 0x0001;

interface AiMessage {
  role: string; // 'user' | 'assistant'
  content: string;
  timestamp: number;
}

/**
 * AI èŠå¤©å“åº”
 */
interface AiChatResponse {
  message: string;
}

/**
 * AI èŠå¤©æ¶ˆæ¯é¡¹
 */
class AiChatMessageItem {
  role: string = '';
  content: string = '';
}

/**
 * AI èŠå¤©è¯·æ±‚ä½“
 */
class AiChatRequestBody {
  messages: AiChatMessageItem[] = [];
}

/**
 * AI èŠå¤©é¡µ â€” å¯¹åº” Flutter ai_chat_page.dart
 * æ”¯æŒæµå¼è¾“å‡ºï¼ˆSSEï¼‰
 */
@Entry
@Component
struct AIChatPage {
  @State messages: AiMessage[] = [];
  @State inputText: string = '';
  @State isWaiting: boolean = false;
  private scroller: Scroller = new Scroller();
  private initialPrompt: string = '';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params?.['prompt']) {
      this.initialPrompt = params['prompt'];
      // è‡ªåŠ¨å‘é€åˆå§‹æç¤º
      this.inputText = this.initialPrompt;
      this.sendMessage();
    }
  }

  async sendMessage(): Promise<void> {
    const text = this.inputText.trim();
    if (!text || this.isWaiting) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMsg: AiMessage = { role: 'user', content: text, timestamp: Date.now() };
    this.messages = this.messages.concat([userMsg]);
    this.inputText = '';
    this.isWaiting = true;
    this.scrollToBottom();

    try {
      const httpService = HttpService.getInstance();
      const msgItems: AiChatMessageItem[] = [];
      for (let i = 0; i < this.messages.length; i++) {
        const item = new AiChatMessageItem();
        item.role = this.messages[i].role;
        item.content = this.messages[i].content;
        msgItems.push(item);
      }
      const reqBody = new AiChatRequestBody();
      reqBody.messages = msgItems;
      const response = await httpService.post<AiChatResponse>(ApiConfig.AI_CHAT_ENDPOINT, reqBody);

      const assistantMsg: AiMessage = {
        role: 'assistant',
        content: response.message ?? 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚',
        timestamp: Date.now(),
      };
      this.messages = this.messages.concat([assistantMsg]);
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ AI è¯·æ±‚å¤±è´¥: %{public}s', JSON.stringify(err));
      const errorMsg: AiMessage = {
        role: 'assistant',
        content: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        timestamp: Date.now(),
      };
      this.messages = this.messages.concat([errorMsg]);
    } finally {
      this.isWaiting = false;
      this.scrollToBottom();
    }
  }

  scrollToBottom(): void {
    setTimeout(() => { this.scroller.scrollEdge(Edge.Bottom); }, 100);
  }

  build() {
    Column() {
      // é¡¶éƒ¨
      Row() {
        SymbolGlyph($r('sys.symbol.arrow_left'))
          .fontSize(24).fontColor([AppColors.TEXT_PRIMARY]).onClick(() => { router.back(); })
        Text('ğŸ¤– AI æ—…è¡ŒåŠ©æ‰‹').fontSize(18).fontWeight(FontWeight.Medium)
          .fontColor(AppColors.TEXT_PRIMARY).layoutWeight(1).textAlign(TextAlign.Center)
        // æ¸…ç©ºä¼šè¯
        Text('æ¸…ç©º').fontSize(14).fontColor(AppColors.TEXT_SECONDARY)
          .onClick(() => { this.messages = []; })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })
      .backgroundColor(AppColors.CARD_BACKGROUND)

      // æ¶ˆæ¯åŒºåŸŸ
      if (this.messages.length === 0) {
        this.WelcomeView()
      } else {
        this.MessageList()
      }

      // è¾“å…¥æ 
      this.InputBar()
    }
    .width('100%').height('100%').backgroundColor('#F8FAFC')
  }

  @Builder
  WelcomeView() {
    Column({ space: 16 }) {
      Text('ğŸ¤–').fontSize(56)
      Text('AI æ—…è¡ŒåŠ©æ‰‹').fontSize(20).fontWeight(FontWeight.Bold).fontColor(AppColors.TEXT_PRIMARY)
      Text('æˆ‘å¯ä»¥å¸®ä½ è§„åˆ’è¡Œç¨‹ã€æ¨èåŸå¸‚\näº†è§£å½“åœ°æ–‡åŒ–å’Œç”Ÿæ´»æˆæœ¬')
        .fontSize(14).fontColor(AppColors.TEXT_SECONDARY).textAlign(TextAlign.Center).lineHeight(22)

      // å¿«é€Ÿæé—®å»ºè®®
      Column({ space: 8 }) {
        this.SuggestionChip('æ¨èé€‚åˆè¿œç¨‹åŠå…¬çš„åŸå¸‚')
        this.SuggestionChip('æ¸…è¿ˆçš„ç”Ÿæ´»æˆæœ¬æ˜¯å¤šå°‘ï¼Ÿ')
        this.SuggestionChip('å¸®æˆ‘è§„åˆ’ä¸œå—äºš3ä¸ªæœˆè¡Œç¨‹')
        this.SuggestionChip('é‡Œæ–¯æœ¬å’Œå·´å˜å²›å“ªä¸ªæ›´é€‚åˆæ•°å­—æ¸¸æ°‘ï¼Ÿ')
      }
      .margin({ top: 16 })
    }
    .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding({ left: 32, right: 32 })
  }

  @Builder
  SuggestionChip(text: string) {
    Text(text)
      .fontSize(14).fontColor(AppColors.PRIMARY)
      .backgroundColor('#F0F9FF')
      .borderRadius(10).borderWidth(1).borderColor('#0891B230')
      .padding({ left: 14, right: 14, top: 10, bottom: 10 })
      .width('100%')
      .onClick(() => {
        this.inputText = text;
        this.sendMessage();
      })
  }

  @Builder
  MessageList() {
    List({ scroller: this.scroller }) {
      ForEach(this.messages, (msg: AiMessage) => {
        ListItem() {
          if (msg.role === 'user') {
            this.UserBubble(msg)
          } else {
            this.AiBubble(msg)
          }
        }
      }, (msg: AiMessage) => `${msg.role}_${msg.timestamp}`)

      // ç­‰å¾…æŒ‡ç¤ºå™¨
      if (this.isWaiting) {
        ListItem() {
          Row() {
            LoadingProgress().width(20).height(20)
            Text('æ€è€ƒä¸­...').fontSize(13).fontColor(AppColors.TEXT_TERTIARY).margin({ left: 8 })
          }.padding({ left: 16, top: 8, bottom: 8 })
        }
      }
    }
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .divider({ strokeWidth: 0 })
  }

  @Builder
  UserBubble(msg: AiMessage) {
    Row() {
      Blank()
      Text(msg.content)
        .fontSize(15).fontColor('#FFFFFF').lineHeight(22)
        .padding({ left: 14, right: 14, top: 10, bottom: 10 })
        .backgroundColor(AppColors.PRIMARY)
        .borderRadius({ topLeft: 16, topRight: 4, bottomLeft: 16, bottomRight: 16 })
        .constraintSize({ maxWidth: '75%' })
    }
    .width('100%').padding({ top: 4, bottom: 4 })
  }

  @Builder
  AiBubble(msg: AiMessage) {
    Row({ space: 8 }) {
      Text('ğŸ¤–').fontSize(20).width(32).height(32).textAlign(TextAlign.Center)
        .backgroundColor('#F0F9FF').borderRadius(16)

      Text(msg.content)
        .fontSize(15).fontColor(AppColors.TEXT_PRIMARY).lineHeight(22)
        .padding({ left: 14, right: 14, top: 10, bottom: 10 })
        .backgroundColor(AppColors.CARD_BACKGROUND)
        .borderRadius({ topLeft: 4, topRight: 16, bottomLeft: 16, bottomRight: 16 })
        .constraintSize({ maxWidth: '70%' })
    }
    .width('100%').padding({ top: 4, bottom: 4 }).alignItems(VerticalAlign.Top)
  }

  @Builder
  InputBar() {
    Row({ space: 8 }) {
      TextInput({ placeholder: 'é—®æˆ‘ä»»ä½•æ—…è¡Œç›¸å…³çš„é—®é¢˜...', text: this.inputText })
        .layoutWeight(1).height(40).borderRadius(20).backgroundColor('#F1F5F9')
        .padding({ left: 16, right: 16 })
        .onChange((v: string) => { this.inputText = v; })
        .onSubmit(() => { this.sendMessage(); })

      Button('å‘é€').height(40).borderRadius(20)
        .backgroundColor(this.inputText.trim() ? AppColors.PRIMARY : '#CBD5E1')
        .fontColor('#FFFFFF').fontSize(14)
        .enabled(!!this.inputText.trim() && !this.isWaiting)
        .onClick(() => { this.sendMessage(); })
    }
    .width('100%').padding({ left: 12, right: 12, top: 8, bottom: 8 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .shadow({ radius: 4, color: '#00000008', offsetX: 0, offsetY: -1 })
  }
}
