import { AppColors } from '../common/constants/AppColors';
import { RouteConstants } from '../common/constants/RouteConstants';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'CreateTravelPlanPage';
const DOMAIN = 0x0001;

@Entry
@Component
struct CreateTravelPlanPage {
  @State cityName: string = '';
  @State cityId: string = '';
  @State departureLocation: string = '';
  @State departureDate: string = '';
  @State duration: number = 7;
  @State budget: string = 'medium';
  @State customBudget: string = '';
  @State selectedCurrency: string = 'USD';
  @State travelStyle: string = 'culture';
  @State selectedInterests: string[] = [];
  @State selectedAttractions: string[] = [];
  @State errorMessage: string = '';
  @State isSubmitting: boolean = false;

  private readonly durationOptions: number[] = [3, 5, 7, 10, 14];
  private readonly budgetOptions: Array<{ key: string; label: string }> = [
    { key: 'low', label: 'Budget' },
    { key: 'medium', label: 'Moderate' },
    { key: 'high', label: 'Luxury' },
    { key: 'custom', label: 'Custom' },
  ];
  private readonly currencyOptions: string[] = ['USD', 'CNY', 'EUR', 'JPY'];
  private readonly styleOptions: Array<{ key: string; label: string; emoji: string }> = [
    { key: 'culture', label: 'æ–‡åŒ–æ¢ç´¢', emoji: 'ğŸ›ï¸' },
    { key: 'adventure', label: 'å†’é™©ä½“éªŒ', emoji: 'ğŸ•ï¸' },
    { key: 'relaxation', label: 'æ”¾æ¾ç–—æ„ˆ', emoji: 'ğŸ–ï¸' },
    { key: 'nightlife', label: 'å¤œç”Ÿæ´»', emoji: 'ğŸŒƒ' },
  ];
  private readonly interestOptions: string[] = [
    'å†å²å¤è¿¹',
    'åšç‰©é¦†',
    'åŸå¸‚æ¼«æ­¥',
    'å’–å•¡é¦†',
    'å¤œç”Ÿæ´»',
    'å½“åœ°ç¾é£Ÿ',
    'è‡ªç„¶å¾’æ­¥',
    'æ‹ç…§æ‰“å¡',
    'äº²å­å‹å¥½',
    'åˆ›æ„å¸‚é›†',
  ];
  private readonly attractionOptions: Array<{ id: string; label: string }> = [
    { id: 'historic', label: 'å†å²å¤è¿¹' },
    { id: 'museum', label: 'åšç‰©é¦†' },
    { id: 'park', label: 'å…¬å›­ç»¿åœ°' },
    { id: 'food_district', label: 'ç¾é£Ÿè¡—åŒº' },
    { id: 'shopping_mall', label: 'è´­ç‰©ä¸­å¿ƒ' },
    { id: 'art_gallery', label: 'è‰ºæœ¯ç”»å»Š' },
    { id: 'viewpoint', label: 'è§‚æ™¯å°' },
    { id: 'night_market', label: 'å¤œå¸‚' },
  ];

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params) {
      this.cityId = params['cityId'] ?? '';
      this.cityName = params['cityName'] ?? '';
    }
  }

  private toggleInterest(interest: string): void {
    const idx = this.selectedInterests.indexOf(interest);
    if (idx >= 0) {
      this.selectedInterests.splice(idx, 1);
      this.selectedInterests = [...this.selectedInterests];
    } else {
      this.selectedInterests.push(interest);
      this.selectedInterests = [...this.selectedInterests];
    }
  }

  private toggleAttraction(id: string): void {
    const idx = this.selectedAttractions.indexOf(id);
    if (idx >= 0) {
      this.selectedAttractions.splice(idx, 1);
      this.selectedAttractions = [...this.selectedAttractions];
    } else {
      this.selectedAttractions.push(id);
      this.selectedAttractions = [...this.selectedAttractions];
    }
  }

  private validate(): boolean {
    this.cityName = this.cityName.trim();
    this.departureLocation = this.departureLocation.trim();
    this.departureDate = this.departureDate.trim();
    this.customBudget = this.customBudget.trim();

    if (!this.cityName) {
      this.errorMessage = 'è¯·è¾“å…¥ç›®çš„åœ°åŸå¸‚';
      return false;
    }
    if (!this.departureDate) {
      this.errorMessage = 'è¯·è¾“å…¥å‡ºå‘æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰';
      return false;
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(this.departureDate)) {
      this.errorMessage = 'å‡ºå‘æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ YYYY-MM-DD';
      return false;
    }
    if (this.budget === 'custom' && !this.customBudget) {
      this.errorMessage = 'è¯·è¾“å…¥è‡ªå®šä¹‰é¢„ç®—é‡‘é¢';
      return false;
    }
    if (this.budget === 'custom') {
      const custom = Number(this.customBudget);
      if (!Number.isFinite(custom) || custom <= 0) {
        this.errorMessage = 'è‡ªå®šä¹‰é¢„ç®—å¿…é¡»ä¸ºå¤§äº 0 çš„æ•°å­—';
        return false;
      }
    }
    if (this.selectedInterests.length === 0) {
      this.errorMessage = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå…´è¶£æ ‡ç­¾';
      return false;
    }
    this.errorMessage = '';
    return true;
  }

  submit(): void {
    if (this.isSubmitting) {
      return;
    }
    if (!this.validate()) {
      return;
    }

    this.isSubmitting = true;
    hilog.info(DOMAIN, TAG, 'ğŸš€ å¼€å§‹ç”Ÿæˆæ—…è¡Œè®¡åˆ’, city=%{public}s', this.cityName);
    router.pushUrl({
      url: `pages/${RouteConstants.TRAVEL_PLAN}`,
      params: {
        cityId: this.cityId,
        cityName: this.cityName,
        duration: this.duration,
        budget: this.budget,
        travelStyle: this.travelStyle,
        interests: this.selectedInterests,
        selectedAttractions: this.selectedAttractions,
        departureLocation: this.departureLocation,
        departureDate: this.departureDate,
        customBudget: this.customBudget,
        selectedCurrency: this.selectedCurrency,
      },
    });
    this.isSubmitting = false;
  }

  build() {
    Column() {
      Row() {
        SymbolGlyph($r('sys.symbol.arrow_left'))
          .fontSize(24)
          .fontColor([AppColors.TEXT_PRIMARY])
          .onClick(() => {
            router.back();
          })
        Text('åˆ›å»ºæ—…è¡Œè®¡åˆ’')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(AppColors.TEXT_PRIMARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Column().width(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(AppColors.CARD_BACKGROUND)

      Scroll() {
        Column({ space: 14 }) {
          this.HeaderCard()

          this.FormField('ç›®çš„åœ°åŸå¸‚', this.cityName, (v: string) => {
            this.cityName = v;
          }, 'ä¾‹ï¼šå¤§é˜ª / Chiang Mai')

          this.FormField('å‡ºå‘åœ°', this.departureLocation, (v: string) => {
            this.departureLocation = v;
          }, 'ä¾‹ï¼šä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº')

          this.FormField('å‡ºå‘æ—¥æœŸ', this.departureDate, (v: string) => {
            this.departureDate = v;
          }, 'YYYY-MM-DD')

          this.DurationSection()

          this.BudgetSection()

          if (this.budget === 'custom') {
            this.FormField('è‡ªå®šä¹‰é¢„ç®—', this.customBudget, (v: string) => {
              this.customBudget = v;
            }, 'ä¾‹ï¼š3000')

            this.CurrencySection()
          }

          this.StyleSection()

          this.InterestsSection()

          this.AttractionsSection()

          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(13)
              .fontColor('#DC2626')
              .width('100%')
          }

          Button(this.isSubmitting ? 'è·³è½¬ä¸­...' : 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’')
            .width('100%')
            .height(44)
            .borderRadius(12)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor(AppColors.WHITE)
            .enabled(!this.isSubmitting)
            .onClick(async () => {
              await this.submit();
            })

          Column().height(40)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  HeaderCard() {
    Column({ space: 8 }) {
      Text('ğŸ¤– AI Travel Planner')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.WHITE)
      Text('å‘Šè¯‰æˆ‘ä½ çš„åå¥½ï¼Œæˆ‘ä¼šç”Ÿæˆæ›´è´´åˆä½ çš„æ¯æ—¥è¡Œç¨‹ä¸é¢„ç®—å»ºè®®ã€‚')
        .fontSize(13)
        .fontColor('#FFEFF2')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding({ left: 14, right: 14, top: 14, bottom: 14 })
    .backgroundColor(AppColors.PRIMARY)
    .borderRadius(12)
  }

  @Builder
  FormField(label: string, value: string, onChange: (v: string) => void, placeholder: string) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)
      TextInput({ text: value, placeholder: placeholder })
        .width('100%')
        .height(44)
        .borderRadius(10)
        .backgroundColor(AppColors.WHITE)
        .border({ width: 1, color: AppColors.BORDER_LIGHT })
        .padding({ left: 12, right: 12 })
        .fontSize(14)
        .onChange((v: string) => {
          onChange(v);
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DurationSection() {
    Column({ space: 8 }) {
      Text('è¡Œç¨‹å¤©æ•°')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.durationOptions, (item: number) => {
          Text(`${item}å¤©`)
            .fontSize(13)
            .fontColor(this.duration === item ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.duration === item ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(() => {
              this.duration = item;
            })
        }, (item: number) => `duration-${item}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  BudgetSection() {
    Column({ space: 8 }) {
      Text('é¢„ç®—ç­‰çº§')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.budgetOptions, (item: { key: string; label: string }) => {
          Text(item.label)
            .fontSize(13)
            .fontColor(this.budget === item.key ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.budget === item.key ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(() => {
              this.budget = item.key;
              if (this.budget !== 'custom') {
                this.customBudget = '';
              }
            })
        }, (item: { key: string; label: string }) => `budget-${item.key}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  CurrencySection() {
    Column({ space: 8 }) {
      Text('å¸ç§')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.currencyOptions, (item: string) => {
          Text(item)
            .fontSize(13)
            .fontColor(this.selectedCurrency === item ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.selectedCurrency === item ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(() => {
              this.selectedCurrency = item;
            })
        }, (item: string) => `currency-${item}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StyleSection() {
    Column({ space: 8 }) {
      Text('æ—…è¡Œé£æ ¼')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.styleOptions, (item: { key: string; label: string; emoji: string }) => {
          Text(`${item.emoji} ${item.label}`)
            .fontSize(13)
            .fontColor(this.travelStyle === item.key ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.travelStyle === item.key ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(() => {
              this.travelStyle = item.key;
            })
        }, (item: { key: string; label: string; emoji: string }) => `style-${item.key}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  InterestsSection() {
    Column({ space: 8 }) {
      Text('å…´è¶£åå¥½ï¼ˆå¯å¤šé€‰ï¼‰')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.interestOptions, (item: string) => {
          Text(item)
            .fontSize(13)
            .fontColor(this.selectedInterests.indexOf(item) >= 0 ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.selectedInterests.indexOf(item) >= 0 ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(async () => {
              await this.toggleInterest(item);
            })
        }, (item: string) => `interest-${item}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  AttractionsSection() {
    Column({ space: 8 }) {
      Text('æƒ³å»çš„æ™¯ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row({ space: 8 }) {
        ForEach(this.attractionOptions, (item: { id: string; label: string }) => {
          const selected = this.selectedAttractions.indexOf(item.id) >= 0;
          Text(item.label)
            .fontSize(13)
            .fontColor(selected ? AppColors.WHITE : AppColors.TEXT_SECONDARY)
            .backgroundColor(selected ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 7, bottom: 7 })
            .onClick(async () => {
              await this.toggleAttraction(item.id);
            })
        }, (item: { id: string; label: string }) => `attraction-${item.id}`)
      }
      .width('100%')
      .flexWrap(FlexWrap.Wrap)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
}
