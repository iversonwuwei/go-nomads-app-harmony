import { hilog } from '@kit.PerformanceAnalysisKit';
import { TokenStorageService } from '../services/TokenStorageService';
import { AuthUser, AuthStatus } from '../models/AuthModels';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { AuthStore } from '../state/AuthStore';
import { AuthService } from './AuthService';

const TAG = 'AppInitService';
const DOMAIN = 0x0001;

/**
 * åº”ç”¨åˆå§‹åŒ–æœåŠ¡ - å¯¹åº” Flutter ç«¯ app_init_service.dart
 * è´Ÿè´£åˆå§‹åŒ–å…¨å±€çŠ¶æ€ã€æ¢å¤ç™»å½•çŠ¶æ€
 */
export class AppInitService {
  private static instance: AppInitService | null = null;

  static getInstance(): AppInitService {
    if (!AppInitService.instance) {
      AppInitService.instance = new AppInitService();
    }
    return AppInitService.instance;
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ - æ¢å¤ç™»å½•çŠ¶æ€
   */
  async initialize(): Promise<void> {
    hilog.info(DOMAIN, TAG, 'ğŸ¯ å¼€å§‹åº”ç”¨åˆå§‹åŒ–...');

    // åˆå§‹åŒ–å…¨å±€çŠ¶æ€é»˜è®¤å€¼
    this.initializeAppStorage();

    // åˆå§‹åŒ–è®¤è¯æœåŠ¡ï¼ˆè®¾ç½®å…¨å±€ 401 å›è°ƒï¼‰
    AuthService.getInstance();

    // å°è¯•æ¢å¤ç™»å½•çŠ¶æ€
    await this.restoreAuthState();

    hilog.info(DOMAIN, TAG, 'âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
  }

  /**
   * åˆå§‹åŒ– AppStorage é»˜è®¤å€¼
   */
  private initializeAppStorage(): void {
    AppStorage.setOrCreate(AppStorageKeys.AUTH_STATUS, AuthStatus.Unknown);
    AppStorage.setOrCreate(AppStorageKeys.IS_AUTHENTICATED, false);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_TAB_INDEX, 0);
    AppStorage.setOrCreate(AppStorageKeys.UNREAD_NOTIFICATION_COUNT, 0);
    AppStorage.setOrCreate(AppStorageKeys.IS_INITIALIZED, false);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_LOCALE, 'zh-CN');
  }

  /**
   * æ¢å¤è®¤è¯çŠ¶æ€
   */
  private async restoreAuthState(): Promise<void> {
    const tokenService = TokenStorageService.getInstance();

    try {
      const token = tokenService.getAccessToken();
      if (!token) {
        hilog.info(DOMAIN, TAG, 'ğŸ“± æ²¡æœ‰ä¿å­˜çš„ Tokenï¼Œç”¨æˆ·æœªç™»å½•');
        AuthStore.getInstance().setUnauthenticated();
        return;
      }

      // æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
      if (tokenService.isTokenExpired()) {
        hilog.info(DOMAIN, TAG, 'â° Token å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
        const refreshed = await AuthService.getInstance().refreshToken();
        if (!refreshed) {
          hilog.info(DOMAIN, TAG, 'âŒ Token åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤è®¤è¯');
          await tokenService.clearAll();
          AuthStore.getInstance().setUnauthenticated();
          return;
        }
      }

      // Token æœ‰æ•ˆï¼Œæ¢å¤ç”¨æˆ·ä¿¡æ¯
      const userId = tokenService.getUserId();
      const userName = tokenService.getUserName();
      const userEmail = tokenService.getUserEmail();
      const userRole = tokenService.getUserRole();

      if (userId && userName && userEmail) {
        const user: AuthUser = {
          id: userId,
          userName: userName,
          email: userEmail,
          role: userRole ?? 'user',
        };
        AuthStore.getInstance().setAuthenticated(user);
        hilog.info(DOMAIN, TAG, 'âœ… ç™»å½•çŠ¶æ€æ¢å¤æˆåŠŸ: %{public}s', userName);
      } else {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ Token æœ‰æ•ˆä½†ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
        AuthStore.getInstance().setUnauthenticated();
      }
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ æ¢å¤è®¤è¯çŠ¶æ€å¤±è´¥: %{public}s', JSON.stringify(err));
      AuthStore.getInstance().setUnauthenticated();
    }
  }
}
