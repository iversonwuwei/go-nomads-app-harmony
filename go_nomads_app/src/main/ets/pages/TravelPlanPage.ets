import { AppColors } from '../common/constants/AppColors';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { RouteConstants } from '../common/constants/RouteConstants';
import { TravelPlanService } from '../services/TravelPlanService';
import { TravelPlanSummary } from '../models/TravelPlanSummary';
import { router } from '@kit.ArkUI';
import clipboard from '@ohos.clipboard';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'TravelPlanPage';
const DOMAIN = 0x0001;

/**
 * æ—…è¡Œè®¡åˆ’é¡µ â€” å¯¹åº” Flutter travel_plan_page.dart
 */
@Entry
@Component
struct TravelPlanPage {
  @State plans: TravelPlanSummary[] = [];
  @State detail: Record<string, Object> | null = null;
  @State isLoading: boolean = true;
  @State isGenerating: boolean = false;
  @State hasError: boolean = false;
  @State errorMessage: string = '';
  @State actionMessage: string = '';
  @State progressMessage: string = 'æ­£åœ¨å‡†å¤‡...';
  @State progressValue: number = 0;
  @State viewMode: string = 'list'; // list | detail
  @State selectedFilter: string = 'å…¨éƒ¨';
  @State currentPlanId: string = '';
  @State hasAutoGeneratedOnce: boolean = false;
  @StorageProp(AppStorageKeys.IS_AUTHENTICATED) isAuthenticated: boolean = false;

  private filters: string[] = ['å…¨éƒ¨', 'è®¡åˆ’ä¸­', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'];
  private cityId: string = '';
  private cityName: string = '';
  private duration: number = 7;
  private budget: string = 'medium';
  private travelStyle: string = 'culture';
  private interests: string[] = [];
  private selectedAttractions: string[] = [];
  private departureLocation: string = '';
  private departureDate: string = '';
  private customBudget: string = '';
  private selectedCurrency: string = 'USD';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.currentPlanId = (params['planId'] as string) ?? '';
      this.cityId = (params['cityId'] as string) ?? '';
      this.cityName = (params['cityName'] as string) ?? '';
      this.duration = Number((params['duration'] as number) ?? 7);
      this.budget = (params['budget'] as string) ?? 'medium';
      this.travelStyle = (params['travelStyle'] as string) ?? 'culture';
      this.departureLocation = (params['departureLocation'] as string) ?? '';
      this.departureDate = (params['departureDate'] as string) ?? '';
      this.customBudget = (params['customBudget'] as string) ?? '';
      this.selectedCurrency = (params['selectedCurrency'] as string) ?? 'USD';
      const rawInterests = params['interests'];
      if (rawInterests instanceof Array) {
        this.interests = (rawInterests as Object[]).map((item: Object) => String(item));
      }
      const rawAttractions = params['selectedAttractions'];
      if (rawAttractions instanceof Array) {
        this.selectedAttractions = (rawAttractions as Object[]).map((item: Object) => String(item));
      }
    }

    if (this.currentPlanId.length > 0) {
      this.viewMode = 'detail';
      this.loadDetail(this.currentPlanId);
      return;
    }

    if (this.cityId.length > 0 || this.cityName.length > 0) {
      this.viewMode = 'detail';
      if (!this.hasAutoGeneratedOnce) {
        this.hasAutoGeneratedOnce = true;
        this.generatePlanFromPreferences();
      }
      return;
    }

    this.viewMode = 'list';
    if (this.isAuthenticated) {
      this.loadPlans();
    } else {
      this.isLoading = false;
    }
  }

  async loadPlans(): Promise<void> {
    if (this.isLoading || this.isGenerating) {
      return;
    }
    this.isLoading = true;
    this.hasError = false;
    this.errorMessage = '';
    try {
      const service = TravelPlanService.getInstance();
      this.plans = await service.getList(1, 50);
      hilog.info(DOMAIN, TAG, 'âœ… åŠ è½½ %{public}d ä¸ªæ—…è¡Œè®¡åˆ’', this.plans.length);
    } catch (err) {
      this.hasError = true;
      this.errorMessage = (err as Error).message;
      hilog.error(DOMAIN, TAG, 'âŒ åŠ è½½åˆ—è¡¨å¤±è´¥ %{public}s', JSON.stringify(err));
    } finally { this.isLoading = false; }
  }

  async loadDetail(planId: string): Promise<void> {
    if (this.isLoading || this.isGenerating || !planId) {
      return;
    }
    this.isLoading = true;
    this.isGenerating = false;
    this.hasError = false;
    this.errorMessage = '';
    this.actionMessage = '';
    try {
      const service = TravelPlanService.getInstance();
      const detail = await service.getDetail(planId);
      if (!detail) {
        this.hasError = true;
        this.errorMessage = 'æ— æ³•åŠ è½½æ—…è¡Œè®¡åˆ’è¯¦æƒ…';
        return;
      }
      this.detail = detail;
      this.currentPlanId = this.readString(detail, 'id');
    } catch (err) {
      this.hasError = true;
      this.errorMessage = (err as Error).message;
      hilog.error(DOMAIN, TAG, 'âŒ åŠ è½½è¯¦æƒ…å¤±è´¥ %{public}s', this.errorMessage);
    } finally {
      this.isLoading = false;
    }
  }

  async generatePlanFromPreferences(): Promise<void> {
    if (this.isGenerating || this.isLoading) {
      return;
    }
    this.isLoading = true;
    this.isGenerating = true;
    this.progressValue = 3;
    this.progressMessage = 'æ­£åœ¨è¿æ¥ AI æœåŠ¡...';
    this.hasError = false;
    this.errorMessage = '';
    this.actionMessage = '';

    try {
      const service = TravelPlanService.getInstance();
      const result = await service.createPlanFromPreferences(
        this.cityId,
        this.cityName,
        this.duration,
        this.budget,
        this.travelStyle,
        this.interests,
        this.departureLocation,
        this.departureDate,
        this.customBudget,
        this.selectedCurrency,
        this.selectedAttractions,
        (progress: number, message: string): void => {
          this.progressValue = progress;
          if (message && message.length > 0) {
            this.progressMessage = message;
          }
        },
      );

      await this.updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼Œæ­£åœ¨æ‰“å¼€è¯¦æƒ…...');

      if (!result) {
        this.hasError = true;
        this.errorMessage = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        return;
      }

      this.hasAutoGeneratedOnce = true;

      const createdId = this.readString(result, 'id');
      if (createdId.length > 0) {
        this.currentPlanId = createdId;
        await this.loadDetail(createdId);
      } else {
        this.detail = result;
      }
      this.actionMessage = 'Travel plan generated successfully!';
    } catch (err) {
      this.hasError = true;
      this.errorMessage = `ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥: ${(err as Error).message}`;
      hilog.error(DOMAIN, TAG, 'âŒ ç”Ÿæˆå¤±è´¥ %{public}s', this.errorMessage);
    } finally {
      this.isLoading = false;
      this.isGenerating = false;
    }
  }

  private async updateProgress(value: number, message: string): Promise<void> {
    this.progressValue = value;
    this.progressMessage = message;
    try {
      await this.delay(320);
    } finally {
    }
  }

  private delay(ms: number): Promise<void> {
    return new Promise<void>((resolve: () => void) => {
      setTimeout(() => {
        resolve();
      }, ms);
    });
  }

  getFilteredPlans(): TravelPlanSummary[] {
    switch (this.selectedFilter) {
      case 'è®¡åˆ’ä¸­': return this.plans.filter(p => {
        const status = (p.status ?? '').toLowerCase();
        return status === 'planned' || status === 'published';
      });
      case 'è¿›è¡Œä¸­': return this.plans.filter(p => {
        const status = (p.status ?? '').toLowerCase();
        return status === 'active' || status === 'processing';
      });
      case 'å·²å®Œæˆ': return this.plans.filter(p => p.status === 'completed');
      default: return this.plans;
    }
  }

  private readRecord(source: Record<string, Object> | null, key: string): Record<string, Object> | null {
    if (!source) return null;
    const value = source[key];
    if (!value) return null;
    const record = value as Record<string, Object>;
    return record ?? null;
  }

  private readArray(source: Record<string, Object> | null, key: string): Object[] {
    if (!source) return [];
    const value = source[key];
    if (value instanceof Array) {
      return value as Object[];
    }
    return [];
  }

  private readString(source: Record<string, Object> | null, key: string): string {
    if (!source) return '';
    const value = source[key];
    if (typeof value === 'string') {
      return value;
    }
    if (typeof value === 'number') {
      return String(value);
    }
    return '';
  }

  private readNumber(source: Record<string, Object> | null, key: string, fallback: number = 0): number {
    if (!source) return fallback;
    const value = source[key];
    if (typeof value === 'number') {
      return value;
    }
    if (typeof value === 'string') {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : fallback;
    }
    return fallback;
  }

  private detailDestination(): Record<string, Object> | null {
    return this.readRecord(this.detail, 'destination');
  }

  private detailMetadata(): Record<string, Object> | null {
    return this.readRecord(this.detail, 'metadata');
  }

  private detailCityName(): string {
    const destination = this.detailDestination();
    const fromDetail = this.readString(destination, 'cityName');
    if (fromDetail.length > 0) return fromDetail;
    if (this.cityName.length > 0) return this.cityName;
    return this.readString(this.detail, 'cityName');
  }

  private detailDuration(): number {
    const metadata = this.detailMetadata();
    const fromMetadata = this.readNumber(metadata, 'duration', 0);
    if (fromMetadata > 0) return fromMetadata;
    const fromRoot = this.readNumber(this.detail, 'duration', 0);
    if (fromRoot > 0) return fromRoot;
    return this.duration;
  }

  private detailStatus(): string {
    const status = this.readString(this.detail, 'status');
    return status.length > 0 ? status : 'planned';
  }

  private detailBudgetLabel(): string {
    const metadata = this.detailMetadata();
    const value = this.readString(metadata, 'budgetLevel') || this.readString(this.detail, 'budget');
    if (value === 'low') return 'Budget';
    if (value === 'high') return 'Luxury';
    if (value.length === 0) return 'Moderate';
    return value;
  }

  private detailStyleLabel(): string {
    const metadata = this.detailMetadata();
    const value = this.readString(metadata, 'style') || this.readString(this.detail, 'travelStyle');
    return value.length > 0 ? value : 'culture';
  }

  private detailTransportation(): Record<string, Object> | null {
    return this.readRecord(this.detail, 'transportation');
  }

  private detailAccommodation(): Record<string, Object> | null {
    return this.readRecord(this.detail, 'accommodation');
  }

  private detailBudget(): Record<string, Object> | null {
    const breakdown = this.readRecord(this.detail, 'budgetBreakdown');
    if (breakdown) {
      return breakdown;
    }
    return this.readRecord(this.detail, 'budget');
  }

  private detailBudgetCurrency(): string {
    return this.readString(this.detailBudget(), 'currency') || 'USD';
  }

  private detailBudgetTotal(): number {
    return this.readNumber(this.detailBudget(), 'total', 0);
  }

  private transportArrivalMethod(): string {
    const transport = this.detailTransportation();
    return this.readString(transport, 'arrivalMethod') || this.readString(this.readRecord(transport, 'arrival'), 'method');
  }

  private transportArrivalDetails(): string {
    const transport = this.detailTransportation();
    return this.readString(transport, 'arrivalDetails') || this.readString(this.readRecord(transport, 'arrival'), 'details');
  }

  private transportEstimatedCost(): number {
    const transport = this.detailTransportation();
    const fromFlat = this.readNumber(transport, 'estimatedCost', -1);
    if (fromFlat >= 0) return fromFlat;
    return this.readNumber(this.readRecord(transport, 'arrival'), 'estimatedCost', 0);
  }

  private transportLocalMethod(): string {
    const transport = this.detailTransportation();
    return this.readString(transport, 'localTransport') || this.readString(this.readRecord(transport, 'localTransport'), 'method');
  }

  private transportLocalDetails(): string {
    const transport = this.detailTransportation();
    return this.readString(transport, 'localTransportDetails') || this.readString(this.readRecord(transport, 'localTransport'), 'details');
  }

  private transportDailyCost(): number {
    const transport = this.detailTransportation();
    const fromFlat = this.readNumber(transport, 'dailyTransportCost', -1);
    if (fromFlat >= 0) return fromFlat;
    return this.readNumber(this.readRecord(transport, 'localTransport'), 'dailyCost', 0);
  }

  private accommodationArea(): string {
    const accommodation = this.detailAccommodation();
    return this.readString(accommodation, 'area') || this.readString(accommodation, 'recommendedArea');
  }

  private accommodationPricePerNight(): number {
    return this.readNumber(this.detailAccommodation(), 'pricePerNight', 0);
  }

  private accommodationAmenities(): string {
    const list = this.readArray(this.detailAccommodation(), 'amenities');
    if (list.length === 0) {
      return '';
    }
    return list.slice(0, 5).map((item: Object) => String(item)).join('ã€');
  }

  private accommodationBookingTips(): string {
    return this.readString(this.detailAccommodation(), 'bookingTips');
  }

  private detailItineraries(): Object[] {
    let list = this.readArray(this.detail, 'dailyItineraries');
    if (list.length === 0) {
      list = this.readArray(this.detail, 'itineraries');
    }
    return list;
  }

  private detailAttractions(): Object[] {
    return this.readArray(this.detail, 'attractions');
  }

  private detailRestaurants(): Object[] {
    return this.readArray(this.detail, 'restaurants');
  }

  private detailTips(): string[] {
    const raw = this.readArray(this.detail, 'tips');
    const tips: string[] = [];
    for (const item of raw) {
      tips.push(String(item));
    }
    return tips;
  }

  private detailDepartureLocation(): string {
    return this.readString(this.detail, 'departureLocation') || this.departureLocation;
  }

  private detailDepartureDate(): string {
    return this.readString(this.detail, 'departureDate') || this.departureDate;
  }

  private detailInterests(): string[] {
    const metadata = this.detailMetadata();
    const list = this.readArray(metadata, 'interests');
    if (list.length > 0) {
      return list.slice(0, 8).map((item: Object) => String(item));
    }
    const fallback = this.readArray(this.detail, 'interests');
    return fallback.slice(0, 8).map((item: Object) => String(item));
  }

  private formatMoney(value: number): string {
    if (!Number.isFinite(value) || value <= 0) {
      return '-';
    }
    return `${this.detailBudgetCurrency()} ${Math.round(value * 10) / 10}`;
  }

  async copyShareText(): Promise<void> {
    if (!this.detail) return;
    const city = this.detailCityName();
    const days = this.detailDuration();
    const departure = this.detailDepartureLocation();
    const shareUrl = this.currentPlanId.length > 0
      ? `https://nomadcities.app/travel-plans/${this.currentPlanId}`
      : 'https://nomadcities.app/travel-plans';
    const text = `${city} ${days}å¤©æ—…è¡Œè®¡åˆ’\né¢„ç®—ï¼š${this.detailBudgetLabel()}\né£æ ¼ï¼š${this.detailStyleLabel()}${departure.length > 0 ? `\nå‡ºå‘åœ°ï¼š${departure}` : ''}\n${shareUrl}`;
    try {
      await clipboard.setData(text);
      this.actionMessage = 'åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶ï¼Œå¯ç›´æ¥å‘é€ç»™å¥½å‹';
      this.errorMessage = '';
    } catch (err) {
      this.errorMessage = `å¤åˆ¶å¤±è´¥: ${(err as Error).message}`;
    }
  }

  build() {
    Column() {
      this.TopBar()

      if (this.actionMessage.length > 0) {
        Text(this.actionMessage)
          .fontSize(13)
          .fontColor(AppColors.SUCCESS)
          .backgroundColor('#E8F5E9')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .margin({ left: 16, right: 16, top: 10 })
      }

      if (this.errorMessage.length > 0 && this.hasError) {
        Text(this.errorMessage)
          .fontSize(13)
          .fontColor(AppColors.ERROR)
          .backgroundColor('#FEE2E2')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .margin({ left: 16, right: 16, top: 10 })
      }

      if (this.viewMode === 'list') {
        this.ListViewContent()
      } else {
        this.DetailViewContent()
      }
    }
    .width('100%').height('100%').backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  TopBar() {
    Row() {
      SymbolGlyph($r('sys.symbol.arrow_left'))
        .fontSize(24)
        .fontColor([AppColors.TEXT_PRIMARY])
        .onClick(() => {
          router.back();
        })

      Text(this.viewMode === 'detail' ? 'æ—…è¡Œè®¡åˆ’è¯¦æƒ…' : 'æ—…è¡Œè®¡åˆ’')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      if (this.viewMode === 'detail') {
        Text('åˆ†äº«')
          .fontSize(13)
          .fontColor(this.isLoading || this.isGenerating || !this.detail ? AppColors.TEXT_TERTIARY : AppColors.PRIMARY)
          .padding({ left: 8, right: 8, top: 6, bottom: 6 })
          .onClick(() => {
            if (!this.isLoading && !this.isGenerating && this.detail) {
              this.copyShareText();
            }
          })
      } else {
        Button('+')
          .width(34)
          .height(34)
          .borderRadius(17)
          .backgroundColor(AppColors.PRIMARY)
          .fontColor('#FFFFFF')
          .onClick(() => {
            router.pushUrl({ url: `pages/${RouteConstants.CREATE_TRAVEL_PLAN}` });
          })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
  }

  @Builder
  ListViewContent() {
    Column() {
      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.filters, (f: string) => {
            Text(f)
              .fontSize(13)
              .fontColor(this.selectedFilter === f ? '#FFFFFF' : AppColors.TEXT_SECONDARY)
              .backgroundColor(this.selectedFilter === f ? AppColors.PRIMARY : '#F1F5F9')
              .borderRadius(16)
              .padding({ left: 14, right: 14, top: 6, bottom: 6 })
              .onClick(() => {
                this.selectedFilter = f;
              })
          }, (f: string) => f)
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')

      if (!this.isAuthenticated) {
        Column({ space: 12 }) {
          Text('âœˆï¸').fontSize(48)
          Text('ç™»å½•åç®¡ç†æ—…è¡Œè®¡åˆ’').fontSize(16).fontColor(AppColors.TEXT_SECONDARY)
          Button('å»ç™»å½•')
            .width(120)
            .height(40)
            .borderRadius(20)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor('#FFFFFF')
            .onClick(async () => {
              await this.loadPlans();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.hasError) {
        Column({ space: 12 }) {
          Text(this.errorMessage.length > 0 ? this.errorMessage : 'åŠ è½½å¤±è´¥')
            .fontSize(14)
            .fontColor(AppColors.ERROR)
          Button('é‡è¯•')
            .height(40)
            .borderRadius(10)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor(AppColors.WHITE)
            .onClick(async () => {
              await this.loadPlans();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.getFilteredPlans().length === 0) {
        Column({ space: 12 }) {
          Text('âœˆï¸').fontSize(48)
          Text('è¿˜æ²¡æœ‰æ—…è¡Œè®¡åˆ’').fontSize(16).fontColor(AppColors.TEXT_SECONDARY)
          Text('åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæ—…è¡Œè®¡åˆ’å§').fontSize(14).fontColor(AppColors.TEXT_TERTIARY)
          Button('åˆ›å»ºè®¡åˆ’')
            .height(40)
            .borderRadius(20)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor('#FFFFFF')
            .onClick(() => {
              router.pushUrl({ url: `pages/${RouteConstants.CREATE_TRAVEL_PLAN}` });
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.getFilteredPlans(), (plan: TravelPlanSummary) => {
            ListItem() {
              this.PlanCard(plan)
            }
          }, (plan: TravelPlanSummary) => plan.id)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        .divider({ strokeWidth: 0 })
        .edgeEffect(EdgeEffect.Spring)
      }
    }
    .layoutWeight(1)
  }

  @Builder
  DetailViewContent() {
    Column() {
      if (this.isLoading && this.isGenerating) {
        Scroll() {
          Column({ space: 14 }) {
            Column({ space: 12 }) {
              Text('ğŸ¤–').fontSize(44)
              Text(this.progressMessage)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor(AppColors.TEXT_PRIMARY)
              Text(`${this.progressValue}%`)
                .fontSize(13)
                .fontColor(AppColors.TEXT_SECONDARY)
            }
            .width('100%')
            .padding({ top: 12, bottom: 4 })

            ForEach([1, 2, 3, 4], (index: number) => {
              Column()
                .width('100%')
                .height(index === 1 ? 140 : 110)
                .backgroundColor('#F3F4F6')
                .borderRadius(12)
            }, (index: number) => `skeleton-${index}`)
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 18, bottom: 18 })
        }
        .layoutWeight(1)
      } else if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.hasError || !this.detail) {
        Column({ space: 12 }) {
          Text(this.errorMessage.length > 0 ? this.errorMessage : 'æ—…è¡Œè®¡åˆ’ä¸å­˜åœ¨')
            .fontSize(14)
            .fontColor(AppColors.ERROR)
          Button('é‡è¯•')
            .height(40)
            .borderRadius(10)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor(AppColors.WHITE)
            .enabled(!this.isGenerating && !this.isLoading)
            .onClick(() => {
              if (this.currentPlanId.length > 0) {
                this.loadDetail(this.currentPlanId);
              } else {
                this.generatePlanFromPreferences();
              }
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column({ space: 12 }) {
            this.OverviewCard()
            this.TransportationCard()
            this.AccommodationCard()
            this.BudgetCard()
            this.ItineraryCard()
            this.RecommendationCard('æ™¯ç‚¹æ¨è', this.detailAttractions(), 'name')
            this.RecommendationCard('é¤å…æ¨è', this.detailRestaurants(), 'name')
            this.TipsCard()

            Column().height(80)
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 14, bottom: 14 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .layoutWeight(1)
  }

  @Builder
  PlanCard(plan: TravelPlanSummary) {
    Column() {
      if ((plan.cityImage ?? '').length > 0) {
        Image(plan.cityImage ?? '')
          .width('100%').height(120).objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 12, topRight: 12 })
      }
      Column({ space: 6 }) {
        Row() {
          Text(plan.cityName ?? 'æ—…è¡Œè®¡åˆ’').fontSize(16).fontWeight(FontWeight.Bold)
            .fontColor(AppColors.TEXT_PRIMARY).layoutWeight(1)
            .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(this.statusLabel(plan.status ?? 'planned')).fontSize(11)
            .fontColor(this.statusColor(plan.status ?? 'planned'))
            .backgroundColor(`${this.statusColor(plan.status ?? 'planned')}18`)
            .borderRadius(4).padding({ left: 6, right: 6, top: 2, bottom: 2 })
        }.width('100%')

        Text(`ğŸ—“ï¸ ${plan.durationDays ?? '--'} å¤© Â· ${plan.destinationsCount ?? 1} ç«™`)
          .fontSize(13).fontColor(AppColors.TEXT_SECONDARY)

        if ((plan.budgetLevel ?? '').length > 0 || (plan.travelStyle ?? '').length > 0) {
          Text(`ğŸ’° ${plan.budgetLevel ?? '--'}    ğŸ¯ ${plan.travelStyle ?? '--'}`)
            .fontSize(12)
            .fontColor(AppColors.TEXT_TERTIARY)
        }

        if ((plan.departureDate ?? '').length > 0) {
          Text(`ğŸ›« å‡ºå‘ï¼š${plan.departureDate}`)
            .fontSize(12)
            .fontColor(AppColors.TEXT_TERTIARY)
        }
      }
      .width('100%').padding({ left: 14, right: 14, top: (plan.cityImage ?? '').length > 0 ? 10 : 14, bottom: 14 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%').backgroundColor(AppColors.CARD_BACKGROUND).borderRadius(12)
    .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 }).margin({ bottom: 12 })
    .onClick(() => {
      router.pushUrl({
        url: `pages/${RouteConstants.TRAVEL_PLAN}`,
        params: { planId: plan.id },
      });
    })
  }

  @Builder
  OverviewCard() {
    Column({ space: 8 }) {
      Text('è¡Œç¨‹æ¦‚è§ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      Text(`ğŸ“ ${this.detailCityName()} Â· ${this.detailDuration()} å¤©`)
        .fontSize(14)
        .fontColor(AppColors.TEXT_SECONDARY)

      Text(`ğŸ’° é¢„ç®—ï¼š${this.detailBudgetLabel()}    ğŸ¯ é£æ ¼ï¼š${this.detailStyleLabel()}`)
        .fontSize(13)
        .fontColor(AppColors.TEXT_TERTIARY)

      if (this.detailDepartureLocation().length > 0 || this.detailDepartureDate().length > 0) {
        Text(`ğŸ›« å‡ºå‘ï¼š${this.detailDepartureLocation() || 'å¾…å®š'}${this.detailDepartureDate().length > 0 ? ` Â· ${this.detailDepartureDate()}` : ''}`)
          .fontSize(13)
          .fontColor(AppColors.TEXT_TERTIARY)
      }

      if (this.detailInterests().length > 0) {
        Text(`ğŸ·ï¸ åå¥½ï¼š${this.detailInterests().join(' / ')}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }

      Text(`ğŸ“Œ çŠ¶æ€ï¼š${this.statusLabel(this.detailStatus())}`)
        .fontSize(13)
        .fontColor(this.statusColor(this.detailStatus()))
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  TransportationCard() {
    const arrivalCost = this.transportEstimatedCost();
    const localCost = this.transportDailyCost();

    Column({ space: 8 }) {
      Text('äº¤é€šæ–¹æ¡ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      Text(`âœˆï¸ åˆ°è¾¾æ–¹å¼ï¼š${this.transportArrivalMethod() || 'å¾…è§„åˆ’'}`)
        .fontSize(13)
        .fontColor(AppColors.TEXT_SECONDARY)
      Text(this.transportArrivalDetails() || 'æ­£åœ¨æ ¹æ®åå¥½æ¨èæœ€ä¼˜åˆ°è¾¾è·¯çº¿')
        .fontSize(13)
        .fontColor(AppColors.TEXT_TERTIARY)
      if (arrivalCost > 0) {
        Text(`ğŸ’µ åˆ°è¾¾é¢„ç®—ï¼š${this.detailBudgetCurrency()} ${arrivalCost}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
      }

      Text(`ğŸš• å¸‚å†…äº¤é€šï¼š${this.transportLocalMethod() || 'å…¬å…±äº¤é€š + æ­¥è¡Œ'}`)
        .fontSize(13)
        .fontColor(AppColors.TEXT_SECONDARY)
      Text(this.transportLocalDetails() || 'ä¼˜å…ˆåœ°é“/å…¬äº¤ï¼Œæ­é…æ­¥è¡Œæ¢ç´¢åŸå¸‚')
        .fontSize(13)
        .fontColor(AppColors.TEXT_TERTIARY)
      if (localCost > 0) {
        Text(`ğŸ“† æ¯æ—¥äº¤é€šé¢„ç®—ï¼š${this.detailBudgetCurrency()} ${localCost}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  AccommodationCard() {
    const accommodation = this.detailAccommodation();
    const amenities = this.accommodationAmenities();
    const bookingTips = this.accommodationBookingTips();
    const pricePerNight = this.accommodationPricePerNight();

    Column({ space: 8 }) {
      Text('ä½å®¿å»ºè®®')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      Text(`ğŸ¨ ç±»å‹ï¼š${this.readString(accommodation, 'type') || 'é…’åº— / å…¬å¯“'}`)
        .fontSize(13)
        .fontColor(AppColors.TEXT_SECONDARY)

      Text(`ğŸ“ æ¨èåŒºåŸŸï¼š${this.accommodationArea() || 'å¸‚ä¸­å¿ƒä¸äº¤é€šæ¢çº½é™„è¿‘'}`)
        .fontSize(13)
        .fontColor(AppColors.TEXT_SECONDARY)

      if (pricePerNight > 0) {
        Text(`ğŸ’µ å‚è€ƒä»·æ ¼ï¼š${this.detailBudgetCurrency()} ${pricePerNight}/æ™š`)
          .fontSize(13)
          .fontColor(AppColors.TEXT_SECONDARY)
      }

      Text(this.readString(accommodation, 'recommendation') || 'ä¼˜å…ˆé€‰æ‹©äº¤é€šä¾¿åˆ©ã€è¯„ä»·è¾ƒé«˜çš„ä½å®¿ï¼Œå¹¶å…³æ³¨å¯å…è´¹å–æ¶ˆæ”¿ç­–ã€‚')
        .fontSize(13)
        .fontColor(AppColors.TEXT_TERTIARY)

      if (amenities.length > 0) {
        Text(`ğŸ§° è®¾æ–½ï¼š${amenities}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
      }

      if (bookingTips.length > 0) {
        Text(`ğŸ’¡ é¢„è®¢æç¤ºï¼š${bookingTips}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  BudgetCard() {
    const budget = this.detailBudget();
    const currency = this.detailBudgetCurrency();
    const transportation = this.readNumber(budget, 'transportation', 0);
    const accommodation = this.readNumber(budget, 'accommodation', 0);
    const food = this.readNumber(budget, 'food', 0);
    const activities = this.readNumber(budget, 'activities', 0);
    const miscellaneous = this.readNumber(budget, 'miscellaneous', 0);
    const total = this.detailBudgetTotal();
    const daily = this.detailDuration() > 0 ? Math.round(total / this.detailDuration()) : 0;

    Column({ space: 8 }) {
      Text('é¢„ç®—åˆ†é…')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      if (total > 0) {
        Text(`ğŸ’µ é¢„ä¼°æ€»é¢„ç®—ï¼š${currency} ${total}`)
          .fontSize(13)
          .fontColor(AppColors.TEXT_SECONDARY)
        Text(`ğŸ“† æ—¥å‡é¢„ç®—ï¼š${currency} ${daily}`)
          .fontSize(13)
          .fontColor(AppColors.TEXT_SECONDARY)

        Text(`äº¤é€š ${transportation} Â· ä½å®¿ ${accommodation} Â· é¤é¥® ${food}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
        Text(`æ´»åŠ¨ ${activities} Â· å…¶ä»– ${miscellaneous}`)
          .fontSize(12)
          .fontColor(AppColors.TEXT_TERTIARY)
      } else {
        Text('ç³»ç»Ÿå°†æ ¹æ®ç›®çš„åœ°æ¶ˆè´¹æ°´å¹³å’Œè¡Œç¨‹åå¥½è‡ªåŠ¨ç”Ÿæˆé¢„ç®—åŒºé—´ã€‚')
          .fontSize(13)
          .fontColor(AppColors.TEXT_TERTIARY)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  ItineraryCard() {
    const itineraries = this.detailItineraries();

    Column({ space: 8 }) {
      Text('æ¯æ—¥è¡Œç¨‹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      if (itineraries.length === 0) {
        Text('æ­£åœ¨æ•´ç†æ›´ç»†åŒ–çš„æ¯æ—¥å®‰æ’ï¼Œç¨åå¯å†æ¬¡æŸ¥çœ‹ã€‚')
          .fontSize(13)
          .fontColor(AppColors.TEXT_TERTIARY)
      } else {
        ForEach(itineraries.slice(0, 5), (it: Object, index?: number) => {
          const item = it as Record<string, Object>;
          const day = this.readNumber(item, 'day', (index ?? 0) + 1);
          const title = this.readString(item, 'theme') || this.readString(item, 'title') || `Day ${day}`;
          const summary = this.readString(item, 'notes') || this.readString(item, 'summary') || 'æ¢ç´¢åŸå¸‚ç‰¹è‰²æ™¯ç‚¹ä¸æœ¬åœ°ä½“éªŒ';
          const activities = this.readArray(item, 'activities');

          Column({ space: 4 }) {
            Text(`Day ${day} Â· ${title}`)
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor(AppColors.TEXT_PRIMARY)
            Text(summary)
              .fontSize(12)
              .fontColor(AppColors.TEXT_SECONDARY)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            if (activities.length > 0) {
              ForEach(activities.slice(0, 3), (ac: Object, acIndex?: number) => {
                const activity = ac as Record<string, Object>;
                const acTime = this.readString(activity, 'time') || '--:--';
                const acName = this.readString(activity, 'name') || `æ´»åŠ¨ ${((acIndex ?? 0) + 1)}`;
                const acLocation = this.readString(activity, 'location');
                const acCost = this.readNumber(activity, 'estimatedCost', 0);

                Row({ space: 6 }) {
                  Text(acTime)
                    .fontSize(11)
                    .fontColor(AppColors.TEXT_TERTIARY)
                    .width(44)
                  Column({ space: 2 }) {
                    Text(acName)
                      .fontSize(12)
                      .fontColor(AppColors.TEXT_PRIMARY)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                    Text(`${acLocation.length > 0 ? acLocation : 'åœ°ç‚¹å¾…å®š'}${acCost > 0 ? ` Â· ${this.formatMoney(acCost)}` : ''}`)
                      .fontSize(11)
                      .fontColor(AppColors.TEXT_TERTIARY)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
              }, (_ac: Object, acIndex?: number) => `activity-${day}-${acIndex ?? 0}`)
              if (activities.length > 3) {
                Text(`è¿˜æœ‰ ${activities.length - 3} é¡¹æ´»åŠ¨...`)
                  .fontSize(11)
                  .fontColor(AppColors.TEXT_TERTIARY)
              }
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .padding({ top: 8, bottom: 8 })
          .border({ width: { bottom: 1 }, color: AppColors.BORDER_LIGHT })
        }, (_it: Object, index?: number) => `itinerary-${index ?? 0}`)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  RecommendationCard(title: string, items: Object[], nameKey: string) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      if (items.length === 0) {
        Text('æš‚æ— æ¨èæ•°æ®')
          .fontSize(13)
          .fontColor(AppColors.TEXT_TERTIARY)
      } else {
        ForEach(items.slice(0, 6), (it: Object, index?: number) => {
          const item = it as Record<string, Object>;
          const name = this.readString(item, nameKey) || this.readString(item, 'title') || 'æ¨èåœ°ç‚¹';
          const desc = this.readString(item, 'description') || this.readString(item, 'reason');
          const rating = this.readNumber(item, 'rating', 0);
          const location = this.readString(item, 'location');
          const category = this.readString(item, 'category') || this.readString(item, 'cuisine');

          Column({ space: 4 }) {
            Text(`â€¢ ${name}`)
              .fontSize(13)
              .fontColor(AppColors.TEXT_PRIMARY)
              .fontWeight(FontWeight.Medium)

            if (category.length > 0 || location.length > 0 || rating > 0) {
              Text(`${category.length > 0 ? category : 'æ¨è'}${rating > 0 ? ` Â· â­${rating.toFixed(1)}` : ''}${location.length > 0 ? ` Â· ${location}` : ''}`)
                .fontSize(12)
                .fontColor(AppColors.TEXT_TERTIARY)
            }

            if (desc.length > 0) {
              Text(desc)
                .fontSize(12)
                .fontColor(AppColors.TEXT_SECONDARY)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .padding({ top: 6, bottom: 6 })
        }, (_it: Object, index?: number) => `${title}-${index ?? 0}`)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  @Builder
  TipsCard() {
    const tips = this.detailTips();
    Column({ space: 8 }) {
      Text('å®ç”¨å»ºè®®')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      if (tips.length === 0) {
        Text('å¸¦å¥½è¯ä»¶ä¸å¸¸ç”¨è¯å“ï¼Œä¼˜å…ˆé¢„è®¢å¯å–æ¶ˆèµ„æºï¼Œå…³æ³¨ç›®çš„åœ°å¤©æ°”ã€‚')
          .fontSize(13)
          .fontColor(AppColors.TEXT_TERTIARY)
      } else {
        ForEach(tips.slice(0, 8), (tip: string, index?: number) => {
          Text(`â€¢ ${tip}`)
            .fontSize(13)
            .fontColor(AppColors.TEXT_SECONDARY)
            .width('100%')
            .textAlign(TextAlign.Start)
        }, (_tip: string, index?: number) => `tip-${index ?? 0}`)
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding(14)
    .backgroundColor(AppColors.WHITE)
    .borderRadius(12)
    .border({ width: 1, color: AppColors.BORDER_LIGHT })
  }

  statusLabel(status: string): string {
    switch (status) {
      case 'draft': return 'è‰ç¨¿';
      case 'planned': return 'è®¡åˆ’ä¸­';
      case 'published': return 'è®¡åˆ’ä¸­';
      case 'active': return 'è¿›è¡Œä¸­';
      case 'processing': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return status;
    }
  }

  statusColor(status: string): string {
    switch (status) {
      case 'active': return AppColors.PRIMARY;
      case 'processing': return AppColors.PRIMARY;
      case 'completed': return AppColors.SUCCESS;
      case 'planned': return AppColors.WARNING;
      case 'published': return AppColors.WARNING;
      default: return AppColors.TEXT_TERTIARY;
    }
  }
}
