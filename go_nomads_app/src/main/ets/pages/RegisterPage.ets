import { AppColors } from '../common/constants/AppColors';
import { RouteConstants } from '../common/constants/RouteConstants';
import { AuthService } from '../services/AuthService';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'RegisterPage';
const DOMAIN = 0x0001;

/**
 * æ³¨å†Œé¡µé¢ - 100% è¿˜åŸ Flutter register_page.dart
 *
 * Flutter ç»“æ„:
 *   RegisterHeader â†’ 80x80 circle logo + "ğŸŒ Go Nomad" 32px + subtitle
 *   RegisterForm â†’ 4 fields (user/email/pwd/confirm) radius 12
 *   RegisterTermsCheckbox â†’ checkbox + terms links
 *   RegisterSubmitButton â†’ "Join Nomads" #FF4458
 *   RegisterLoginLink â†’ "Already have an account?" + "Login"
 *   RegisterFeatureHighlights â†’ 5 emoji+title+subtitle items
 */
@Entry
@Component
struct RegisterPage {
  @State userName: string = '';
  @State email: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State agreeTerms: boolean = false;
  @State isPasswordVisible: boolean = false;
  @State isConfirmPasswordVisible: boolean = false;

  async doRegister(): Promise<void> {
    if (!this.agreeTerms) {
      this.errorMessage = 'è¯·å…ˆåŒæ„æœåŠ¡æ¡æ¬¾';
      return;
    }
    if (!this.userName || !this.email || !this.password) {
      this.errorMessage = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹';
      return;
    }
    if (this.password !== this.confirmPassword) {
      this.errorMessage = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
      return;
    }
    if (this.password.length < 6) {
      this.errorMessage = 'å¯†ç è‡³å°‘6ä½';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      await AuthService.getInstance().register(this.userName, this.email, this.password);
      hilog.info(DOMAIN, TAG, 'âœ… æ³¨å†ŒæˆåŠŸ');
      router.replaceUrl({ url: `pages/${RouteConstants.MAIN}` });
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ æ³¨å†Œå¤±è´¥: %{public}s', JSON.stringify(err));
      this.errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // ===== RegisterHeader: 80x80 circle + "ğŸŒ Go Nomad" 32px =====
        Column() {
          // Logo åœ†å½¢å®¹å™¨
          Column() {
            SymbolGlyph($r('sys.symbol.globe_badge_heart'))
              .fontSize(40)
              .fontColor([AppColors.PRIMARY])
          }
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('#1AFF4458')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          Text('ğŸŒ Go Nomad')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.TEXT_BLACK87)
            .margin({ top: 24 })

          Text('åŠ å…¥å…¨çƒæ•°å­—æ¸¸æ°‘ç¤¾åŒº')
            .fontSize(16)
            .fontColor(AppColors.TEXT_TERTIARY)
            .margin({ top: 12 })
            .textAlign(TextAlign.Center)
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ top: 40, bottom: 48 })

        // ===== RegisterForm: 4 fields radius 12 =====
        Column({ space: 20 }) {
          // ç”¨æˆ·å
          TextInput({ placeholder: 'ç”¨æˆ·å', text: this.userName })
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.userName = value;
            })

          // é‚®ç®±
          TextInput({ placeholder: 'é‚®ç®±', text: this.email })
            .type(InputType.Email)
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.email = value;
            })

          // å¯†ç 
          TextInput({ placeholder: 'åˆ›å»ºå¯†ç ', text: this.password })
            .type(this.isPasswordVisible ? InputType.Normal : InputType.Password)
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.password = value;
            })

          // ç¡®è®¤å¯†ç 
          TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirmPassword })
            .type(this.isConfirmPasswordVisible ? InputType.Normal : InputType.Password)
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.confirmPassword = value;
            })
        }
        .width('100%')
        .padding({ left: 24, right: 24 })

        // ===== RegisterTermsCheckbox =====
        Row() {
          Checkbox()
            .select(this.agreeTerms)
            .selectedColor(AppColors.PRIMARY)
            .onChange((value: boolean) => {
              this.agreeTerms = value;
            })
          Text('æˆ‘åŒæ„ ')
            .fontSize(14)
            .fontColor(AppColors.TEXT_BLACK87)
          Text('æœåŠ¡æ¡æ¬¾')
            .fontSize(14)
            .fontColor(AppColors.PRIMARY)
            .decoration({ type: TextDecorationType.Underline })
            .onClick(() => {
              router.pushUrl({ url: `pages/${RouteConstants.TERMS_OF_SERVICE}` });
            })
          Text(' å’Œ ')
            .fontSize(14)
            .fontColor(AppColors.TEXT_BLACK87)
          Text('ç¤¾åŒºå‡†åˆ™')
            .fontSize(14)
            .fontColor(AppColors.PRIMARY)
            .decoration({ type: TextDecorationType.Underline })
            .onClick(() => {
              router.pushUrl({ url: `pages/${RouteConstants.COMMUNITY_GUIDELINES}` });
            })
        }
        .width('100%')
        .padding({ left: 24, right: 24 })
        .margin({ top: 24 })

        // é”™è¯¯æç¤º
        if (this.errorMessage) {
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor(AppColors.ERROR)
            .width('100%')
            .padding({ left: 24, right: 24 })
            .margin({ top: 12 })
        }

        // ===== RegisterSubmitButton: "Join Nomads" #FF4458, 18px w600 =====
        Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'Join Nomads')
          .width('100%')
          .height(52)
          .borderRadius(12)
          .backgroundColor(this.isLoading ? AppColors.GREY300 : AppColors.PRIMARY)
          .fontColor(AppColors.WHITE)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .enabled(!this.isLoading)
          .margin({ left: 24, right: 24, top: 32 })
          .onClick(() => {
            this.doRegister();
          })

        // ===== RegisterLoginLink =====
        Row() {
          Text('Already have an account? ')
            .fontSize(15)
            .fontColor(AppColors.TEXT_BLACK87)
          Text('Login')
            .fontSize(15)
            .fontColor(AppColors.PRIMARY)
            .fontWeight(FontWeight.Bold)
            .onClick(() => {
              router.back();
            })
        }
        .margin({ top: 32 })
        .justifyContent(FlexAlign.Center)

        // ===== RegisterFeatureHighlights =====
        Column() {
          Text('Join 38,000+ members')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.GREY700)
            .width('100%')

          this.FeatureItem('ğŸ¹', 'Attend meetups', 'In cities worldwide')
          this.FeatureItem('â¤ï¸', 'Meet new people', 'For dating and friends')
          this.FeatureItem('ğŸ§ª', 'Research destinations', 'Find the best place')
          this.FeatureItem('ğŸ’¬', 'Join exclusive chat', 'Messages sent this month')
          this.FeatureItem('ğŸ—ºï¸', 'Track your travels', 'Share your journey')
        }
        .width('100%')
        .padding(20)
        .margin({ left: 24, right: 24, top: 24 })
        .borderRadius(16)
        .backgroundColor(AppColors.GREY50)

        // åº•éƒ¨é—´è·
        Column()
          .height(40)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.BACKGROUND)
    .scrollable(ScrollDirection.Vertical)
  }

  /**
   * åŠŸèƒ½é¡¹ - Flutter: emoji 24px + title 15px w600 + subtitle 13px grey
   */
  @Builder
  FeatureItem(emoji: string, title: string, subtitle: string) {
    Row() {
      Text(emoji)
        .fontSize(24)
      Column() {
        Text(title)
          .fontSize(15)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_BLACK87)
        Text(subtitle)
          .fontSize(13)
          .fontColor(AppColors.GREY600)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .margin({ top: 12 })
    .alignItems(VerticalAlign.Top)
  }
}
