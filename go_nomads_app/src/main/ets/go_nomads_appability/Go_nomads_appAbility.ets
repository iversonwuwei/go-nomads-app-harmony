import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { TokenStorageService } from '../services/TokenStorageService';
import { AppInitService } from '../services/AppInitService';
import { HttpService } from '../services/HttpService';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { AuthStatus } from '../models/AuthModels';

const DOMAIN = 0x0000;

export default class Go_nomads_appAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');

    // ç»‘å®š TokenStorage ä¸Šä¸‹æ–‡ï¼ˆæ‡’åˆå§‹åŒ–å…œåº•ï¼‰
    TokenStorageService.getInstance().bindContext(this.context);

    // åˆå§‹åŒ–å…¨å±€çŠ¶æ€é»˜è®¤å€¼ï¼ˆAbility åˆ›å»ºæ—¶ç«‹å³è®¾ç½®ï¼Œç¡®ä¿ UI å¯ç”¨å‰å°±æœ‰å€¼ï¼‰
    AppStorage.setOrCreate(AppStorageKeys.AUTH_STATUS, AuthStatus.Unknown);
    AppStorage.setOrCreate(AppStorageKeys.IS_AUTHENTICATED, false);
    AppStorage.setOrCreate(AppStorageKeys.IS_INITIALIZED, false);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_TAB_INDEX, 0);
    AppStorage.setOrCreate(AppStorageKeys.UNREAD_NOTIFICATION_COUNT, 0);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_LOCALE, 'zh-CN');
  }

  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }

  onWindowStageCreate(windowStage: window.WindowStage): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    // å…ˆåŠ è½½å¯åŠ¨é¡µ
    windowStage.loadContent('pages/SplashPage', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading SplashPage.');

      // åœ¨åå°æ‰§è¡Œåˆå§‹åŒ–
      this.performInitialization();
    });
  }

  /**
   * æ‰§è¡Œåº”ç”¨åˆå§‹åŒ–ï¼ˆåŠ è½½ SplashPage ååœ¨åå°æ‰§è¡Œï¼‰
   */
  private async performInitialization(): Promise<void> {
    try {
      hilog.info(DOMAIN, 'testTag', 'ğŸ¯ å¼€å§‹åº”ç”¨åˆå§‹åŒ–...');

      // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ– Token å­˜å‚¨æœåŠ¡
      const tokenService = TokenStorageService.getInstance();
      await tokenService.init(this.context);
      hilog.info(DOMAIN, 'testTag', 'âœ… TokenStorageService åˆå§‹åŒ–å®Œæˆ');

      // ç¬¬äºŒæ­¥ï¼šè®¾ç½® HttpService çš„ 401 å›è°ƒ
      HttpService.getInstance().onUnauthorized = () => {
        AppStorage.set(AppStorageKeys.IS_AUTHENTICATED, false);
        AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
      };

      // ç¬¬ä¸‰æ­¥ï¼šæ¢å¤ç™»å½•çŠ¶æ€
      const appInitService = AppInitService.getInstance();
      await appInitService.initialize();
      hilog.info(DOMAIN, 'testTag', 'âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');

      // æ ‡è®°åˆå§‹åŒ–å®Œæˆ - SplashPage ç›‘å¬æ­¤çŠ¶æ€åè‡ªåŠ¨è·³è½¬
      AppStorage.set(AppStorageKeys.IS_INITIALIZED, true);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'âŒ åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(err));
      // å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿå…è®¸è¿›å…¥åº”ç”¨
      AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
      AppStorage.set(AppStorageKeys.IS_INITIALIZED, true);
    }
  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
  }

  onBackground(): void {
    // Ability has back to background
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onBackground');
  }
}