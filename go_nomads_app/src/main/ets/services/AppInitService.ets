import { hilog } from '@kit.PerformanceAnalysisKit';
import { TokenStorageService } from '../services/TokenStorageService';
import { HttpService } from '../services/HttpService';
import { ApiConfig } from '../common/constants/ApiConfig';
import { AuthUser, AuthStatus } from '../models/AuthModels';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';

const TAG = 'AppInitService';
const DOMAIN = 0x0001;

/**
 * Token åˆ·æ–°å“åº”
 */
interface RefreshTokenResponse {
  accessToken: string;
  refreshToken?: string;
  expiresAt?: string;
}

/**
 * Token åˆ·æ–°è¯·æ±‚ä½“
 */
class RefreshTokenRequest {
  refreshToken: string = '';
}

/**
 * åº”ç”¨åˆå§‹åŒ–æœåŠ¡ - å¯¹åº” Flutter ç«¯ app_init_service.dart
 * è´Ÿè´£åˆå§‹åŒ–å…¨å±€çŠ¶æ€ã€æ¢å¤ç™»å½•çŠ¶æ€
 */
export class AppInitService {
  private static instance: AppInitService | null = null;

  static getInstance(): AppInitService {
    if (!AppInitService.instance) {
      AppInitService.instance = new AppInitService();
    }
    return AppInitService.instance;
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ - æ¢å¤ç™»å½•çŠ¶æ€
   */
  async initialize(): Promise<void> {
    hilog.info(DOMAIN, TAG, 'ğŸ¯ å¼€å§‹åº”ç”¨åˆå§‹åŒ–...');

    // åˆå§‹åŒ–å…¨å±€çŠ¶æ€é»˜è®¤å€¼
    this.initializeAppStorage();

    // å°è¯•æ¢å¤ç™»å½•çŠ¶æ€
    await this.restoreAuthState();

    hilog.info(DOMAIN, TAG, 'âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
  }

  /**
   * åˆå§‹åŒ– AppStorage é»˜è®¤å€¼
   */
  private initializeAppStorage(): void {
    AppStorage.setOrCreate(AppStorageKeys.AUTH_STATUS, AuthStatus.Unknown);
    AppStorage.setOrCreate(AppStorageKeys.IS_AUTHENTICATED, false);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_TAB_INDEX, 0);
    AppStorage.setOrCreate(AppStorageKeys.UNREAD_NOTIFICATION_COUNT, 0);
    AppStorage.setOrCreate(AppStorageKeys.IS_INITIALIZED, false);
    AppStorage.setOrCreate(AppStorageKeys.CURRENT_LOCALE, 'zh-CN');
  }

  /**
   * æ¢å¤è®¤è¯çŠ¶æ€
   */
  private async restoreAuthState(): Promise<void> {
    const tokenService = TokenStorageService.getInstance();

    try {
      const token = tokenService.getAccessToken();
      if (!token) {
        hilog.info(DOMAIN, TAG, 'ğŸ“± æ²¡æœ‰ä¿å­˜çš„ Tokenï¼Œç”¨æˆ·æœªç™»å½•');
        AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
        return;
      }

      // æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
      if (tokenService.isTokenExpired()) {
        hilog.info(DOMAIN, TAG, 'â° Token å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
        const refreshed = await this.tryRefreshToken();
        if (!refreshed) {
          hilog.info(DOMAIN, TAG, 'âŒ Token åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤è®¤è¯');
          await tokenService.clearAll();
          AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
          return;
        }
      }

      // Token æœ‰æ•ˆï¼Œæ¢å¤ç”¨æˆ·ä¿¡æ¯
      const userId = tokenService.getUserId();
      const userName = tokenService.getUserName();
      const userEmail = tokenService.getUserEmail();
      const userRole = tokenService.getUserRole();

      if (userId && userName && userEmail) {
        const user: AuthUser = {
          id: userId,
          userName: userName,
          email: userEmail,
          role: userRole ?? 'user',
        };
        AppStorage.set(AppStorageKeys.CURRENT_USER, user);
        AppStorage.set(AppStorageKeys.IS_AUTHENTICATED, true);
        AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Authenticated);
        hilog.info(DOMAIN, TAG, 'âœ… ç™»å½•çŠ¶æ€æ¢å¤æˆåŠŸ: %{public}s', userName);
      } else {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ Token æœ‰æ•ˆä½†ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
        AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
      }
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ æ¢å¤è®¤è¯çŠ¶æ€å¤±è´¥: %{public}s', JSON.stringify(err));
      AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
    }
  }

  /**
   * å°è¯•åˆ·æ–° Token
   */
  private async tryRefreshToken(): Promise<boolean> {
    const tokenService = TokenStorageService.getInstance();
    const refreshToken = tokenService.getRefreshToken();

    if (!refreshToken) {
      return false;
    }

    try {
      const httpService = HttpService.getInstance();
      const reqBody = new RefreshTokenRequest();
      reqBody.refreshToken = refreshToken;
      const result = await httpService.post<RefreshTokenResponse>(
        ApiConfig.REFRESH_TOKEN_ENDPOINT, reqBody);

      if (result.accessToken) {
        await tokenService.saveTokens(
          result.accessToken,
          result.refreshToken,
          result.expiresAt ? new Date(result.expiresAt) : undefined
        );
        hilog.info(DOMAIN, TAG, 'âœ… Token åˆ·æ–°æˆåŠŸ');
        return true;
      }
      return false;
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ Token åˆ·æ–°å¤±è´¥: %{public}s', JSON.stringify(err));
      return false;
    }
  }
}
