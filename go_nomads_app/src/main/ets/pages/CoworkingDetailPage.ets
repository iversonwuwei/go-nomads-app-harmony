import { AppColors } from '../common/constants/AppColors';
import { HttpService } from '../services/HttpService';
import { ApiConfig } from '../common/constants/ApiConfig';
import { CoworkingSpace, CoworkingHelper } from '../models/CoworkingSpace';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'CoworkingDetailPage';
const DOMAIN = 0x0001;

/**
 * ÂÖ±‰∫´ÂäûÂÖ¨Á©∫Èó¥ËØ¶ÊÉÖÈ°µ ‚Äî ÂØπÂ∫î Flutter coworking_detail_page.dart
 */
@Entry
@Component
struct CoworkingDetailPage {
  @State space: CoworkingSpace | null = null;
  @State isLoading: boolean = true;

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params?.['spaceId']) { this.loadSpace(params['spaceId']); }
  }

  async loadSpace(id: string): Promise<void> {
    this.isLoading = true;
    try {
      const httpService = HttpService.getInstance();
      this.space = await httpService.get<CoworkingSpace>(`${ApiConfig.COWORKING_SPACES_ENDPOINT}/${id}`);
    } catch (err) {
      hilog.error(DOMAIN, TAG, '‚ùå %{public}s', JSON.stringify(err));
    } finally { this.isLoading = false; }
  }

  build() {
    Column() {
      if (this.isLoading || !this.space) {
        Column() { LoadingProgress().width(40).height(40) }
          .width('100%').height('100%').justifyContent(FlexAlign.Center)
          .backgroundColor(AppColors.BACKGROUND)
      } else {
        this.DetailContent(this.space!)
      }
    }
    .width('100%').height('100%')
  }

  @Builder
  DetailContent(s: CoworkingSpace) {
    Column() {
      Scroll() {
        Column({ space: 0 }) {
          // Â∞ÅÈù¢Âõæ
          Stack() {
            Image(s.imageUrl || $r('app.media.startIcon'))
              .width('100%').height(220).objectFit(ImageFit.Cover)
            // ËøîÂõûÊåâÈíÆ
            Row() {
              SymbolGlyph($r('sys.symbol.arrow_left'))
                .fontSize(22).fontColor(['#FFFFFF'])
                .onClick(() => { router.back(); })
            }.width('100%').padding({ left: 16, top: 44 })
          }.width('100%')

          Column({ space: 16 }) {
            // ÂêçÁß∞ + È™åËØÅ
            Row({ space: 8 }) {
              Text(s.name).fontSize(22).fontWeight(FontWeight.Bold)
                .fontColor(AppColors.TEXT_PRIMARY).layoutWeight(1)
              if (s.isVerified) {
                Text('Â∑≤ËÆ§ËØÅ ‚úì').fontSize(12).fontColor(AppColors.SUCCESS)
                  .backgroundColor(`${AppColors.SUCCESS}18`).borderRadius(4)
                  .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              }
            }.width('100%')

            // ËØÑÂàÜÂíå‰ª∑Ê†º
            Row({ space: 16 }) {
              Text(`‚≠ê ${s.rating.toFixed(1)} (${s.reviewCount} Êù°ËØÑ‰ª∑)`)
                .fontSize(14).fontColor(AppColors.TEXT_SECONDARY)
              Text(CoworkingHelper.priceLabel(s))
                .fontSize(16).fontWeight(FontWeight.Bold).fontColor(AppColors.PRIMARY)
            }

            // Âú∞ÂùÄ
            if (s.address) {
              Row({ space: 6 }) {
                Text('üìç').fontSize(14)
                Text(s.address).fontSize(14).fontColor(AppColors.TEXT_SECONDARY)
              }
            }

            // WiFi
            if (s.wifiSpeed) {
              Row({ space: 6 }) {
                Text('üì∂').fontSize(14)
                Text(`WiFi ${s.wifiSpeed} Mbps`).fontSize(14).fontColor(AppColors.TEXT_SECONDARY)
              }
            }

            Divider().color(AppColors.DIVIDER)

            // ÊèèËø∞
            if (s.description) {
              Column({ space: 6 }) {
                Text('ÁÆÄ‰ªã').fontSize(16).fontWeight(FontWeight.Medium).fontColor(AppColors.TEXT_PRIMARY)
                Text(s.description).fontSize(14).fontColor(AppColors.TEXT_SECONDARY).lineHeight(22)
              }
              .width('100%').alignItems(HorizontalAlign.Start)
            }

            // ‰ª∑Ê†ºËØ¶ÊÉÖ
            this.PricingSection(s)

            // ËÆæÊñΩ
            this.AmenitiesSection(s)

            // ËøêËê•Êó∂Èó¥
            if (s.openTime) {
              Column({ space: 6 }) {
                Text('üïê Ëê•‰∏öÊó∂Èó¥').fontSize(16).fontWeight(FontWeight.Medium).fontColor(AppColors.TEXT_PRIMARY)
                Text(`${s.openTime} - ${s.closeTime ?? 'ÂÖ≥Èó®'}`).fontSize(14).fontColor(AppColors.TEXT_SECONDARY)
              }
              .width('100%').alignItems(HorizontalAlign.Start)
            }

            // ËÅîÁ≥ªÊñπÂºè
            this.ContactSection(s)

            Column().height(30)
          }
          .padding({ left: 16, right: 16, top: 16 })
          .alignItems(HorizontalAlign.Start)
        }
      }
      .layoutWeight(1).scrollBar(BarState.Off)

      // Â∫ïÊ†è
      Row({ space: 12 }) {
        Column() {
          Text(CoworkingHelper.priceLabel(s)).fontSize(18).fontWeight(FontWeight.Bold).fontColor(AppColors.PRIMARY)
        }.layoutWeight(1)
        Button('ËÅîÁ≥ªÁ©∫Èó¥').height(44).borderRadius(10)
          .backgroundColor(AppColors.PRIMARY).fontColor('#FFFFFF').fontSize(15)
      }
      .width('100%').padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor(AppColors.CARD_BACKGROUND)
      .shadow({ radius: 6, color: '#0000000F', offsetX: 0, offsetY: -2 })
    }
    .width('100%').height('100%').backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  PricingSection(s: CoworkingSpace) {
    Column({ space: 8 }) {
      Text('üí∞ ‰ª∑Ê†º').fontSize(16).fontWeight(FontWeight.Medium).fontColor(AppColors.TEXT_PRIMARY)
      Grid() {
        if (s.hourlyRate) { this.PriceCell(`¬•${s.hourlyRate}`, 'ÊØèÂ∞èÊó∂') }
        if (s.dailyRate) { this.PriceCell(`¬•${s.dailyRate}`, 'ÊØèÂ§©') }
        if (s.weeklyRate) { this.PriceCell(`¬•${s.weeklyRate}`, 'ÊØèÂë®') }
        if (s.monthlyRate) { this.PriceCell(`¬•${s.monthlyRate}`, 'ÊØèÊúà') }
      }
      .columnsTemplate('1fr 1fr').rowsGap(8).columnsGap(8).width('100%')
    }
    .width('100%').alignItems(HorizontalAlign.Start)
  }

  @Builder
  PriceCell(price: string, period: string) {
    GridItem() {
      Column({ space: 2 }) {
        Text(price).fontSize(16).fontWeight(FontWeight.Bold).fontColor(AppColors.PRIMARY)
        Text(period).fontSize(12).fontColor(AppColors.TEXT_TERTIARY)
      }
      .width('100%').padding(10).backgroundColor('#F0F9FF').borderRadius(8)
    }
  }

  @Builder
  AmenitiesSection(s: CoworkingSpace) {
    Column({ space: 8 }) {
      Text('üè¢ ËÆæÊñΩÊúçÂä°').fontSize(16).fontWeight(FontWeight.Medium).fontColor(AppColors.TEXT_PRIMARY)
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(CoworkingHelper.amenitiesList(s), (a: string) => {
          Text(a).fontSize(13).fontColor(AppColors.TEXT_SECONDARY)
            .backgroundColor('#F1F5F9').borderRadius(6)
            .padding({ left: 10, right: 10, top: 5, bottom: 5 })
            .margin({ right: 6, bottom: 6 })
        }, (a: string) => a)
      }
    }
    .width('100%').alignItems(HorizontalAlign.Start)
  }

  @Builder
  ContactSection(s: CoworkingSpace) {
    if (s.phone || s.email || s.website) {
      Column({ space: 8 }) {
        Text('üìû ËÅîÁ≥ªÊñπÂºè').fontSize(16).fontWeight(FontWeight.Medium).fontColor(AppColors.TEXT_PRIMARY)
        if (s.phone) { Text(`ÁîµËØù: ${s.phone}`).fontSize(14).fontColor(AppColors.TEXT_SECONDARY) }
        if (s.email) { Text(`ÈÇÆÁÆ±: ${s.email}`).fontSize(14).fontColor(AppColors.TEXT_SECONDARY) }
        if (s.website) { Text(`ÁΩëÁ´ô: ${s.website}`).fontSize(14).fontColor(AppColors.PRIMARY) }
      }
      .width('100%').alignItems(HorizontalAlign.Start)
    }
  }
}
