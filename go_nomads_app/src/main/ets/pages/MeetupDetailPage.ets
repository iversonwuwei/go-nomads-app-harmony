import { Meetup, MeetupHelper } from '../models/Meetup';
import { MeetupService } from '../services/MeetupService';
import { AppColors } from '../common/constants/AppColors';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { RouteConstants } from '../common/constants/RouteConstants';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'MeetupDetailPage';
const DOMAIN = 0x0001;

/**
 * èšä¼šè¯¦æƒ…é¡µ - å¯¹åº” Flutter ç«¯ MeetupDetailPage
 */
@Entry
@Component
struct MeetupDetailPage {
  @State meetup: Meetup | null = null;
  @State isLoading: boolean = true;
  @State hasError: boolean = false;
  @State errorMsg: string = '';
  @State isJoining: boolean = false;
  @StorageProp(AppStorageKeys.IS_AUTHENTICATED) isAuthenticated: boolean = false;

  private meetupId: string = '';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params) {
      this.meetupId = params['meetupId'] ?? '';
    }
    this.loadMeetupDetail();
  }

  async loadMeetupDetail(): Promise<void> {
    this.isLoading = true;
    this.hasError = false;
    try {
      const meetupService = MeetupService.getInstance();
      const meetup = await meetupService.getMeetupById(this.meetupId);
      this.meetup = meetup;
      hilog.info(DOMAIN, TAG, 'âœ… èšä¼šè¯¦æƒ…åŠ è½½: %{public}s', meetup.title);
    } catch (err) {
      this.hasError = true;
      this.errorMsg = (err instanceof Error) ? err.message : 'åŠ è½½å¤±è´¥';
      hilog.error(DOMAIN, TAG, 'âŒ åŠ è½½èšä¼šè¯¦æƒ…å¤±è´¥: %{public}s', this.errorMsg);
    } finally {
      this.isLoading = false;
    }
  }

  async joinMeetup(): Promise<void> {
    if (this.isJoining || !this.meetup) return;
    this.isJoining = true;
    try {
      const meetupService = MeetupService.getInstance();
      await meetupService.joinMeetup(this.meetupId);
      // é‡æ–°åŠ è½½
      await this.loadMeetupDetail();
      hilog.info(DOMAIN, TAG, 'âœ… å·²åŠ å…¥èšä¼š');
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ åŠ å…¥èšä¼šå¤±è´¥: %{public}s', (err as Error).message);
    } finally {
      this.isJoining = false;
    }
  }

  async leaveMeetup(): Promise<void> {
    if (this.isJoining || !this.meetup) return;
    this.isJoining = true;
    try {
      const meetupService = MeetupService.getInstance();
      await meetupService.leaveMeetup(this.meetupId);
      await this.loadMeetupDetail();
      hilog.info(DOMAIN, TAG, 'âœ… å·²é€€å‡ºèšä¼š');
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ é€€å‡ºèšä¼šå¤±è´¥: %{public}s', (err as Error).message);
    } finally {
      this.isJoining = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      this.TopBar()

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.meetup) {
        Scroll() {
          Column() {
            // å°é¢å›¾
            this.CoverSection()

            // åŸºæœ¬ä¿¡æ¯
            this.InfoSection()

            // è¯¦ç»†æè¿°
            this.DescriptionSection()

            // åœ°ç‚¹ä¿¡æ¯
            this.VenueSection()

            // å‚ä¸è€…
            this.ParticipantsSection()

            Column().height(100)
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)

        // åº•éƒ¨æ“ä½œæ 
        this.BottomActionBar()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  TopBar() {
    Row() {
      SymbolGlyph($r('sys.symbol.arrow_left'))
        .fontSize(24)
        .fontColor([AppColors.TEXT_PRIMARY])
        .onClick(() => {
          router.back();
        })

      Text('èšä¼šè¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      SymbolGlyph($r('sys.symbol.share'))
        .fontSize(22)
        .fontColor([AppColors.TEXT_PRIMARY])
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
  }

  @Builder
  CoverSection() {
    if (this.meetup!.images && this.meetup!.images!.length > 0) {
      Image(this.meetup!.images![0])
        .width('100%')
        .height(200)
        .objectFit(ImageFit.Cover)
    } else if (this.meetup!.imageUrl) {
      Image(this.meetup!.imageUrl!)
        .width('100%')
        .height(200)
        .objectFit(ImageFit.Cover)
    }
  }

  @Builder
  InfoSection() {
    Column({ space: 10 }) {
      // æ ‡é¢˜
      Text(this.meetup!.title)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      // çŠ¶æ€æ ‡ç­¾
      Row({ space: 8 }) {
        Text(this.getMeetupCategoryLabel(this.meetup!.category))
          .fontSize(12)
          .fontColor(AppColors.PRIMARY)
          .backgroundColor('#0891B214')
          .borderRadius(6)
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })

        if (MeetupHelper.isStartingSoon(this.meetup!)) {
          Text('å³å°†å¼€å§‹')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor(AppColors.WARNING)
            .borderRadius(6)
            .padding({ left: 8, right: 8, top: 3, bottom: 3 })
        }
        if (MeetupHelper.isOngoing(this.meetup!)) {
          Text('è¿›è¡Œä¸­')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor(AppColors.SUCCESS)
            .borderRadius(6)
            .padding({ left: 8, right: 8, top: 3, bottom: 3 })
        }
      }

      // æ—¶é—´
      Row({ space: 8 }) {
        Text('ğŸ“…')
          .fontSize(18)
        Column({ space: 2 }) {
          Text(new Date(this.meetup!.startTime).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long',
          }))
            .fontSize(14)
            .fontColor(AppColors.TEXT_PRIMARY)
          Text(`${new Date(this.meetup!.startTime).toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
          })}${this.meetup!.endTime ? ' - ' + new Date(this.meetup!.endTime!).toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
          }) : ''}`)
            .fontSize(13)
            .fontColor(AppColors.TEXT_SECONDARY)
        }
      }

      // ç»„ç»‡è€…
      Row({ space: 8 }) {
        Text('ğŸ‘¤')
          .fontSize(18)
        Text(`ç»„ç»‡è€…ï¼š${this.meetup!.organizer?.name ?? 'æœªçŸ¥'}`)
          .fontSize(14)
          .fontColor(AppColors.TEXT_SECONDARY)
      }
    }
    .width('100%')
    .padding(16)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DescriptionSection() {
    if (this.meetup!.description) {
      Column({ space: 8 }) {
        Text('æ´»åŠ¨ä»‹ç»')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)

        Text(this.meetup!.description)
          .fontSize(14)
          .lineHeight(22)
          .fontColor(AppColors.TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
      .alignItems(HorizontalAlign.Start)
    }
  }

  @Builder
  VenueSection() {
    Column({ space: 8 }) {
      Text('æ´»åŠ¨åœ°ç‚¹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      Row() {
        Column({ space: 4 }) {
          Text(this.meetup!.location ?? this.meetup!.city?.name ?? 'æœªæŒ‡å®šåœ°ç‚¹')
            .fontSize(15)
            .fontColor(AppColors.TEXT_PRIMARY)

          if (this.meetup!.address) {
            Text(this.meetup!.address!)
              .fontSize(13)
              .fontColor(AppColors.TEXT_SECONDARY)
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Text('ğŸ“')
          .fontSize(24)
      }
      .width('100%')
      .padding(14)
      .backgroundColor(AppColors.CARD_BACKGROUND)
      .borderRadius(10)
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  ParticipantsSection() {
    Column({ space: 8 }) {
      Row() {
        Text('å‚ä¸è€…')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)
        Blank()
        Text(`${this.meetup!.participantCount}${this.meetup!.maxParticipants ? '/' + this.meetup!.maxParticipants : ''} äºº`)
          .fontSize(14)
          .fontColor(AppColors.TEXT_SECONDARY)
      }
      .width('100%')

      // å®¹é‡è¿›åº¦æ¡
      if (this.meetup!.maxParticipants) {
        Progress({
          value: this.meetup!.participantCount,
          total: this.meetup!.maxParticipants!,
          type: ProgressType.Linear,
        })
          .width('100%')
          .style({ strokeWidth: 8 })
          .color(this.meetup!.participantCount >= this.meetup!.maxParticipants! ? AppColors.ERROR : AppColors.PRIMARY)
          .backgroundColor('#E2E8F0')
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  BottomActionBar() {
    Row() {
      // å‚åŠ /å·²å‚åŠ æŒ‰é’®
      if (this.meetup!.isParticipant) {
        Button('å·²å‚åŠ  âœ“')
          .layoutWeight(1)
          .height(48)
          .borderRadius(10)
          .backgroundColor('#E8F5E9')
          .fontColor(AppColors.SUCCESS)
          .fontSize(16)
      } else if (MeetupHelper.canJoin(this.meetup!)) {
        Button(this.isJoining ? 'åŠ å…¥ä¸­...' : 'å‚åŠ èšä¼š')
          .layoutWeight(1)
          .height(48)
          .borderRadius(10)
          .backgroundColor(AppColors.PRIMARY)
          .fontColor('#FFFFFF')
          .fontSize(16)
          .enabled(!this.isJoining)
          .onClick(() => {
            if (this.isAuthenticated) {
              this.joinMeetup();
            } else {
              router.pushUrl({ url: `pages/${RouteConstants.LOGIN}` });
            }
          })
      } else {
        Button(MeetupHelper.isEnded(this.meetup!) ? 'å·²ç»“æŸ' : 'åé¢å·²æ»¡')
          .layoutWeight(1)
          .height(48)
          .borderRadius(10)
          .backgroundColor('#E2E8F0')
          .fontColor(AppColors.TEXT_TERTIARY)
          .fontSize(16)
          .enabled(false)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .shadow({ radius: 8, color: '#00000010', offsetX: 0, offsetY: -2 })
  }

  getMeetupCategoryLabel(category: string | undefined): string {
    if (!category) return 'å…¶ä»–';
    switch (category.toLowerCase()) {
      case 'social': return 'ç¤¾äº¤';
      case 'coworking': return 'å…±åŒåŠå…¬';
      case 'workshop': return 'å·¥ä½œåŠ';
      case 'sports': return 'è¿åŠ¨';
      case 'cultural': return 'æ–‡åŒ–';
      case 'networking': return 'ç¤¾äº¤è”ç»œ';
      default: return 'å…¶ä»–';
    }
  }
}
