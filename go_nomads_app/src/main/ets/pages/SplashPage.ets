import { AppColors } from '../common/constants/AppColors';
import { AppStorageKeys } from '../common/constants/AppStorageKeys';
import { AuthStatus } from '../models/AuthModels';
import { RouteConstants } from '../common/constants/RouteConstants';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'SplashPage';
const DOMAIN = 0x0001;

/**
 * å¯åŠ¨é¡µ - å¯¹åº” Flutter ç«¯ SplashLoadingScreen
 * æ˜¾ç¤ºé’è“è‰²èƒŒæ™¯ï¼Œç­‰å¾…åˆå§‹åŒ–å®Œæˆåè·³è½¬
 */
@Entry
@Component
struct SplashPage {
  @StorageProp(AppStorageKeys.AUTH_STATUS) authStatus: AuthStatus = AuthStatus.Unknown;
  @StorageProp(AppStorageKeys.IS_INITIALIZED) isInitialized: boolean = false;
  private hasNavigated: boolean = false;

  aboutToAppear(): void {
    hilog.info(DOMAIN, TAG, 'ğŸ“± SplashPage appeared');
  }

  private navigateToTarget(): void {
    if (this.hasNavigated) {
      return;
    }

    if (!this.isInitialized) {
      return;
    }

    this.hasNavigated = true;
    let targetPage: string;

    if (this.authStatus === AuthStatus.Authenticated) {
      targetPage = RouteConstants.MAIN;
      hilog.info(DOMAIN, TAG, 'ğŸš€ å·²è®¤è¯ï¼Œå¯¼èˆªåˆ°ä¸»é¡µ');
    } else {
      targetPage = RouteConstants.LOGIN;
      hilog.info(DOMAIN, TAG, 'ğŸš€ æœªè®¤è¯ï¼Œå¯¼èˆªåˆ°ç™»å½•é¡µ');
    }

    router.replaceUrl({
      url: `pages/${targetPage}`,
    }).catch((err: Error) => {
      hilog.error(DOMAIN, TAG, 'âŒ å¯¼èˆªå¤±è´¥: %{public}s', JSON.stringify(err));
    });
  }

  build() {
    Column() {
      // åº”ç”¨åç§°
      Text('è¡Œé€”')
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 8 })

      Text('GO-NOMADS')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFFCC')

      // åŠ è½½æŒ‡ç¤ºå™¨
      if (!this.isInitialized) {
        LoadingProgress()
          .width(48)
          .height(48)
          .color('#FFFFFF')
          .margin({ top: 60 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.SPLASH_BACKGROUND)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .onAreaChange(() => {
      // å½“åˆå§‹åŒ–å®Œæˆåè§¦å‘å¯¼èˆª
      if (this.isInitialized && !this.hasNavigated) {
        // å»¶è¿Ÿä¸€å¸§å†å¯¼èˆª
        setTimeout(() => {
          this.navigateToTarget();
        }, 100);
      }
    })
  }
}
