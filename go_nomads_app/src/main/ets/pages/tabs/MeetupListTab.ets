import { Meetup, MeetupHelper, MeetupStatus, MeetupType } from '../../models/Meetup';
import { MeetupService } from '../../services/MeetupService';
import { AppColors } from '../../common/constants/AppColors';
import { RouteConstants } from '../../common/constants/RouteConstants';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'MeetupListTab';
const DOMAIN = 0x0001;

/**
 * èšä¼šåˆ—è¡¨ Tab - å¯¹åº” Flutter ç«¯ MeetupListPage
 */
@Component
export struct MeetupListTab {
  @State meetups: Meetup[] = [];
  @State isLoading: boolean = true;
  @State hasError: boolean = false;
  @State errorMsg: string = '';
  @State selectedFilter: string = 'å…¨éƒ¨';
  @State isRefreshing: boolean = false;

  private filters: string[] = ['å…¨éƒ¨', 'å³å°†å¼€å§‹', 'è¿›è¡Œä¸­', 'æˆ‘å‚åŠ çš„'];

  aboutToAppear(): void {
    this.loadMeetups();
  }

  async loadMeetups(): Promise<void> {
    this.isLoading = true;
    this.hasError = false;
    try {
      const meetupService = MeetupService.getInstance();
      const meetups = await meetupService.getMeetups('upcoming', 1, 50);
      this.meetups = meetups;
      hilog.info(DOMAIN, TAG, 'âœ… åŠ è½½ %{public}d ä¸ªèšä¼š', meetups.length);
    } catch (err) {
      this.hasError = true;
      this.errorMsg = (err instanceof Error) ? err.message : 'åŠ è½½å¤±è´¥';
      hilog.error(DOMAIN, TAG, 'âŒ åŠ è½½èšä¼šå¤±è´¥: %{public}s', this.errorMsg);
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  getFilteredMeetups(): Meetup[] {
    switch (this.selectedFilter) {
      case 'å³å°†å¼€å§‹':
        return this.meetups.filter(m => MeetupHelper.isStartingSoon(m));
      case 'è¿›è¡Œä¸­':
        return this.meetups.filter(m => MeetupHelper.isOngoing(m));
      case 'æˆ‘å‚åŠ çš„':
        return this.meetups.filter(m => m.isJoined === true);
      default:
        return this.meetups;
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜ + åˆ›å»ºæŒ‰é’®
      Row() {
        Text('èšä¼šæ´»åŠ¨')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)

        Blank()

        Button('+ åˆ›å»º')
          .height(34)
          .fontSize(14)
          .borderRadius(17)
          .backgroundColor(AppColors.PRIMARY)
          .fontColor('#FFFFFF')
          .onClick(() => {
            router.pushUrl({ url: `pages/${RouteConstants.CREATE_MEETUP}` });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // ç­›é€‰å™¨
      this.FilterBar()

      // èšä¼šåˆ—è¡¨
      if (this.isLoading && !this.isRefreshing) {
        Column() {
          LoadingProgress().width(40).height(40)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.hasError) {
        Column({ space: 12 }) {
          Text('ğŸ˜').fontSize(48)
          Text('åŠ è½½å¤±è´¥').fontSize(16).fontColor(AppColors.TEXT_SECONDARY)
          Text(this.errorMsg).fontSize(13).fontColor(AppColors.TEXT_TERTIARY)
          Button('é‡è¯•')
            .height(36)
            .fontSize(14)
            .borderRadius(18)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.loadMeetups();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Refresh({ refreshing: $$this.isRefreshing }) {
          this.MeetupList()
        }
        .layoutWeight(1)
        .onRefreshing(() => {
          this.loadMeetups();
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  FilterBar() {
    Scroll() {
      Row({ space: 8 }) {
        ForEach(this.filters, (filter: string) => {
          Text(filter)
            .fontSize(13)
            .fontColor(this.selectedFilter === filter ? '#FFFFFF' : AppColors.TEXT_SECONDARY)
            .backgroundColor(this.selectedFilter === filter ? AppColors.PRIMARY : '#F1F5F9')
            .borderRadius(16)
            .padding({ left: 14, right: 14, top: 6, bottom: 6 })
            .onClick(() => {
              this.selectedFilter = filter;
            })
        }, (filter: string) => filter)
      }
      .padding({ left: 16, right: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .width('100%')
    .margin({ bottom: 12 })
  }

  @Builder
  MeetupList() {
    List() {
      ForEach(this.getFilteredMeetups(), (meetup: Meetup) => {
        ListItem() {
          this.MeetupCard(meetup)
        }
      }, (meetup: Meetup) => meetup.id)
    }
    .layoutWeight(1)
    .divider({ strokeWidth: 0 })
    .edgeEffect(EdgeEffect.Spring)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  MeetupCard(meetup: Meetup) {
    Column() {
      // å°é¢å›¾ï¼ˆå¦‚æœæœ‰ï¼‰
      if (meetup.images.length > 0) {
        Image(meetup.images[0])
          .width('100%')
          .height(140)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 12, topRight: 12 })
      }

      Column({ space: 6 }) {
        // çŠ¶æ€æ ‡ç­¾
        Row({ space: 6 }) {
          Text(this.getMeetupTypeLabel(meetup.type))
            .fontSize(11)
            .fontColor(AppColors.PRIMARY)
            .backgroundColor('#0891B214')
            .borderRadius(4)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })

          if (MeetupHelper.isStartingSoon(meetup)) {
            Text('å³å°†å¼€å§‹')
              .fontSize(11)
              .fontColor('#FFFFFF')
              .backgroundColor(AppColors.WARNING)
              .borderRadius(4)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          }
          if (MeetupHelper.isOngoing(meetup)) {
            Text('è¿›è¡Œä¸­')
              .fontSize(11)
              .fontColor('#FFFFFF')
              .backgroundColor(AppColors.SUCCESS)
              .borderRadius(4)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          }
        }

        // æ ‡é¢˜
        Text(meetup.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.TEXT_PRIMARY)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // æ—¶é—´
        Row({ space: 6 }) {
          Text('ğŸ“…')
            .fontSize(14)
          Text(new Date(meetup.schedule.startTime).toLocaleDateString('zh-CN', {
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          }))
            .fontSize(13)
            .fontColor(AppColors.TEXT_SECONDARY)
        }

        // åœ°ç‚¹
        Row({ space: 6 }) {
          Text('ğŸ“')
            .fontSize(14)
          Text(meetup.venue.name)
            .fontSize(13)
            .fontColor(AppColors.TEXT_SECONDARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }

        // äººæ•° + ç»„ç»‡è€…
        Row() {
          Text(`ğŸ‘¥ ${meetup.capacity.current}${meetup.capacity.max ? '/' + meetup.capacity.max : ''} äºº`)
            .fontSize(12)
            .fontColor(AppColors.TEXT_TERTIARY)

          Blank()

          Row({ space: 4 }) {
            Text(meetup.organizer.name)
              .fontSize(12)
              .fontColor(AppColors.TEXT_TERTIARY)
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding({ left: 14, right: 14, top: meetup.images.length > 0 ? 10 : 14, bottom: 14 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
    .margin({ bottom: 12 })
    .onClick(() => {
      router.pushUrl({
        url: `pages/${RouteConstants.MEETUP_DETAIL}`,
        params: { meetupId: meetup.id },
      });
    })
  }

  getMeetupTypeLabel(type: MeetupType): string {
    switch (type) {
      case MeetupType.Social: return 'ç¤¾äº¤';
      case MeetupType.Coworking: return 'å…±åŒåŠå…¬';
      case MeetupType.Workshop: return 'å·¥ä½œåŠ';
      case MeetupType.Sports: return 'è¿åŠ¨';
      case MeetupType.Cultural: return 'æ–‡åŒ–';
      case MeetupType.Networking: return 'ç¤¾äº¤è”ç»œ';
      default: return 'å…¶ä»–';
    }
  }
}
