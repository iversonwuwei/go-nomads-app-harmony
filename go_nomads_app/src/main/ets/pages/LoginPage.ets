import { AppColors } from '../common/constants/AppColors';
import { RouteConstants } from '../common/constants/RouteConstants';
import { TokenStorageService } from '../services/TokenStorageService';
import { AuthService } from '../services/AuthService';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'LoginPage';
const DOMAIN = 0x0001;

/**
 * ç™»å½•é¡µé¢ - 100% è¿˜åŸ Flutter login_page.dart
 *
 * Flutter ç»“æ„:
 *   LoginHeader â†’ Logo 80x80 åœ† + "Welcome" 32px + "Login" 16px grey
 *   LoginEmailForm â†’ é‚®ç®±/å¯†ç  (radius12) + è®°ä½æˆ‘ + ç™»å½•æŒ‰é’®
 *   LoginSocialButtons â†’ åˆ†éš”çº¿ + å¾®ä¿¡/QQ/æ‰‹æœºå·æŒ‰é’®
 *   LoginCommunityHighlight â†’ 38000+ nomads card
 *   LoginRegisterLink â†’ "Let's Go" + "Register"
 */
@Entry
@Component
struct LoginPage {
  @State email: string = '';
  @State password: string = '';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State rememberMe: boolean = false;
  @State isPasswordVisible: boolean = false;

  aboutToAppear(): void {
    const tokenService = TokenStorageService.getInstance();
    this.rememberMe = tokenService.isRememberMe();
    const savedEmail = tokenService.getSavedEmail();
    if (savedEmail) {
      this.email = savedEmail;
    }
  }

  async doLogin(): Promise<void> {
    if (!this.email || !this.password) {
      this.errorMessage = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
      return;
    }
    this.isLoading = true;
    this.errorMessage = '';
    try {
      await AuthService.getInstance().login(this.email, this.password, this.rememberMe);
      hilog.info(DOMAIN, TAG, 'âœ… ç™»å½•æˆåŠŸ: %{public}s', this.email);
      router.replaceUrl({ url: `pages/${RouteConstants.MAIN}` });
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ ç™»å½•å¤±è´¥: %{public}s', JSON.stringify(err));
      this.errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // ===== LoginHeader: Logo 80x80 åœ† + "Welcome" 32px =====
        Column() {
          // Logo åœ†å½¢å®¹å™¨ 80x80, primaryColor 10% alpha èƒŒæ™¯
          Column() {
            SymbolGlyph($r('sys.symbol.globe_badge_heart'))
              .fontSize(40)
              .fontColor([AppColors.PRIMARY])
          }
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('#1AFF4458') // #FF4458 with 10% alpha
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          // æ ‡é¢˜ "Welcome" 32px bold black87
          Text('Welcome')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.TEXT_BLACK87)
            .margin({ top: 24 })

          // å‰¯æ ‡é¢˜ "Login" 16px grey
          Text('ç™»å½•')
            .fontSize(16)
            .fontColor(AppColors.TEXT_TERTIARY)
            .margin({ top: 12 })
            .textAlign(TextAlign.Center)
        }
        .margin({ top: 60, bottom: 32 })
        .alignItems(HorizontalAlign.Center)

        // ===== LoginEmailForm =====
        Column({ space: 20 }) {
          // é‚®ç®±è¾“å…¥ - radius 12, grey.shade300 border
          TextInput({ placeholder: 'é‚®ç®±', text: this.email })
            .type(InputType.Email)
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.email = value;
            })

          // å¯†ç è¾“å…¥ - radius 12
          TextInput({ placeholder: 'å¯†ç ', text: this.password })
            .type(this.isPasswordVisible ? InputType.Normal : InputType.Password)
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.WHITE)
            .border({ width: 1, color: AppColors.GREY300 })
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.password = value;
            })

          // è®°ä½æˆ‘ & å¿˜è®°å¯†ç  - Flutter: Checkbox activeColor #FF4458
          Row() {
            Row() {
              Checkbox()
                .select(this.rememberMe)
                .selectedColor(AppColors.PRIMARY)
                .onChange((value: boolean) => {
                  this.rememberMe = value;
                })
              Text('è®°ä½æˆ‘')
                .fontSize(14)
                .fontColor(AppColors.TEXT_BLACK87)
                .margin({ left: 4 })
            }

            Blank()

            Text('å¿˜è®°å¯†ç ?')
              .fontSize(14)
              .fontColor(AppColors.PRIMARY)
              .fontWeight(FontWeight.Bold)
              .onClick(() => {
                // TODO: å¿˜è®°å¯†ç 
              })
          }
          .width('100%')

          // é”™è¯¯æç¤º
          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(AppColors.ERROR)
              .width('100%')
          }

          // ç™»å½•æŒ‰é’® - Flutter: full width, #FF4458, white 18px w600, padding 16, radius 12, elevation 0
          Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
            .width('100%')
            .height(52)
            .borderRadius(12)
            .backgroundColor(AppColors.PRIMARY)
            .fontColor(AppColors.WHITE)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .enabled(!this.isLoading)
            .onClick(() => {
              this.doLogin();
            })
        }
        .width('100%')
        .padding({ left: 24, right: 24 })

        // ===== LoginSocialButtons =====
        Column() {
          // åˆ†éš”çº¿ "Or continue with"
          Row() {
            Line().width('35%').height(1).backgroundColor(AppColors.GREY300)
            Text('Or continue with')
              .fontSize(14)
              .fontColor(AppColors.GREY600)
              .margin({ left: 16, right: 16 })
            Line().width('35%').height(1).backgroundColor(AppColors.GREY300)
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(VerticalAlign.Center)
          .margin({ top: 24, bottom: 24 })

          // ç¤¾äº¤æŒ‰é’®è¡Œ1: å¾®ä¿¡ + QQ
          Row({ space: 12 }) {
            // å¾®ä¿¡æŒ‰é’®
            this.SocialButton('å¾®ä¿¡', AppColors.WECHAT_GREEN)
            // QQæŒ‰é’®
            this.SocialButton('QQ', AppColors.QQ_BLUE)
          }
          .width('100%')
          .padding({ left: 24, right: 24 })

          // ç¤¾äº¤æŒ‰é’®è¡Œ2: æ‰‹æœºå·
          Row() {
            this.SocialButton('æ‰‹æœºå·', AppColors.PHONE_GREEN)
          }
          .width('50%')
          .margin({ top: 12 })
          .padding({ left: 24, right: 24 })
        }
        .width('100%')

        // ===== LoginCommunityHighlight =====
        Column() {
          // é¡¶éƒ¨è¡Œ: icon + text
          Row() {
            // iconå®¹å™¨
            Column() {
              SymbolGlyph($r('sys.symbol.person_3'))
                .fontSize(24)
                .fontColor([AppColors.PRIMARY])
            }
            .width(40)
            .height(40)
            .borderRadius(8)
            .backgroundColor('#1AFF4458') // #FF4458 10% alpha
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)

            Column() {
              Text('Join 38,000+ nomads')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppColors.TEXT_BLACK87)
              Text('Living and working around the world')
                .fontSize(13)
                .fontColor(AppColors.GREY600)
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 12 })
            .layoutWeight(1)
          }
          .width('100%')

          // ç‰¹æ€§å¾½ç« è¡Œ
          Row({ space: 8 }) {
            this.FeatureBadge('ğŸ¹', '363 meetups/yr')
            this.FeatureBadge('ğŸ’¬', '15k+ messages')
            this.FeatureBadge('ğŸŒ', '100+ cities')
          }
          .width('100%')
          .margin({ top: 16 })
        }
        .width('100%')
        .padding(20)
        .margin({ left: 24, right: 24, top: 32 })
        .borderRadius(16)
        .backgroundColor(AppColors.GREY50)
        .border({ width: 1, color: AppColors.GREY200 })

        // ===== LoginRegisterLink: "Let's Go" + "Register" =====
        Row() {
          Text("Let's Go")
            .fontSize(15)
            .fontColor(AppColors.TEXT_BLACK87)
          Text(' ')
            .width(8)
          Text('Register')
            .fontSize(15)
            .fontColor(AppColors.PRIMARY)
            .fontWeight(FontWeight.Bold)
            .onClick(() => {
              router.pushUrl({ url: `pages/${RouteConstants.REGISTER}` });
            })
        }
        .margin({ top: 32, bottom: 40 })
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.BACKGROUND)
    .scrollable(ScrollDirection.Vertical)
  }

  /**
   * ç¤¾äº¤ç™»å½•æŒ‰é’® - Flutter: whiteå®¹å™¨, radius 12, grey border, icon+label
   */
  @Builder
  SocialButton(label: string, iconColor: string) {
    Column() {
      // ä½¿ç”¨æ–‡å­—ä»£æ›¿å›¾æ ‡
      Text(label.charAt(0))
        .fontSize(28)
        .fontColor(iconColor)
        .fontWeight(FontWeight.Bold)
      Text(label)
        .fontSize(12)
        .fontColor(AppColors.GREY700)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 6 })
    }
    .layoutWeight(1)
    .padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .borderRadius(12)
    .backgroundColor(AppColors.WHITE)
    .border({ width: 1, color: AppColors.GREY200 })
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      // TODO: social login
    })
  }

  /**
   * ç‰¹æ€§å¾½ç«  - Flutter: whiteå®¹å™¨, radius 8, grey border, emoji+text
   */
  @Builder
  FeatureBadge(emoji: string, text: string) {
    Column() {
      Text(emoji)
        .fontSize(20)
      Text(text)
        .fontSize(11)
        .fontColor(AppColors.GREY700)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 4 })
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .layoutWeight(1)
    .padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .borderRadius(8)
    .backgroundColor(AppColors.WHITE)
    .border({ width: 1, color: AppColors.GREY200 })
    .alignItems(HorizontalAlign.Center)
    .justifyContent(FlexAlign.Center)
  }
}
