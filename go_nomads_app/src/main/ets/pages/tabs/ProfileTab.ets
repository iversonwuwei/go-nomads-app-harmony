import { AppColors } from '../../common/constants/AppColors';
import { AppStorageKeys } from '../../common/constants/AppStorageKeys';
import { RouteConstants } from '../../common/constants/RouteConstants';
import { TokenStorageService } from '../../services/TokenStorageService';
import { HttpService } from '../../services/HttpService';
import { ApiConfig } from '../../common/constants/ApiConfig';
import { AuthUser, AuthStatus } from '../../models/AuthModels';
import { User, UserHelper } from '../../models/User';
import { router } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'ProfileTab';
const DOMAIN = 0x0001;

/**
 * ‰∏™‰∫∫‰∏≠ÂøÉ Tab - ÂØπÂ∫î Flutter Á´Ø ProfilePage
 */
@Component
export struct ProfileTab {
  @StorageProp(AppStorageKeys.IS_AUTHENTICATED) isAuthenticated: boolean = false;
  @StorageProp(AppStorageKeys.CURRENT_USER) currentUser: AuthUser | null = null;
  @State userDetail: User | null = null;
  @State isLoading: boolean = false;

  aboutToAppear(): void {
    if (this.isAuthenticated) {
      this.loadUserProfile();
    }
  }

  async loadUserProfile(): Promise<void> {
    this.isLoading = true;
    try {
      const httpService = HttpService.getInstance();
      const user = await httpService.get<User>(ApiConfig.USER_ME_ENDPOINT);
      this.userDetail = user;
      hilog.info(DOMAIN, TAG, '‚úÖ Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩÊàêÂäü');
    } catch (err) {
      hilog.error(DOMAIN, TAG, '‚ùå Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•: %{public}s', JSON.stringify(err));
    } finally {
      this.isLoading = false;
    }
  }

  async logout(): Promise<void> {
    try {
      // Ë∞ÉÁî®ÂêéÁ´ØÁôªÂá∫
      const httpService = HttpService.getInstance();
      await httpService.post<Object>(ApiConfig.LOGOUT_ENDPOINT).catch(() => {});
    } catch {
      // ÂøΩÁï•ÈîôËØØ
    }

    // Ê∏ÖÈô§Êú¨Âú∞Êï∞ÊçÆ
    await TokenStorageService.getInstance().clearAll();
    AppStorage.set(AppStorageKeys.IS_AUTHENTICATED, false);
    AppStorage.set(AppStorageKeys.AUTH_STATUS, AuthStatus.Unauthenticated);
    AppStorage.set(AppStorageKeys.CURRENT_USER, null);

    router.replaceUrl({ url: `pages/${RouteConstants.LOGIN}` });
  }

  build() {
    Scroll() {
      Column() {
        if (!this.isAuthenticated) {
          this.LoginPrompt()
        } else {
          // Áî®Êà∑Â§¥ÂÉèÂíå‰ø°ÊÅØ
          this.UserInfoSection()

          // ÊóÖË°åÁªüËÆ°
          if (this.userDetail) {
            this.StatsSection()
          }

          // ÂäüËÉΩËèúÂçï
          this.MenuSection()

          // ÈÄÄÂá∫ÁôªÂΩï
          Button('ÈÄÄÂá∫ÁôªÂΩï')
            .width('90%')
            .height(48)
            .borderRadius(10)
            .backgroundColor('#FEE2E2')
            .fontColor(AppColors.ERROR)
            .fontSize(16)
            .margin({ top: 24, bottom: 40 })
            .onClick(() => {
              this.logout();
            })
        }
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
    .backgroundColor(AppColors.BACKGROUND)
  }

  @Builder
  LoginPrompt() {
    Column({ space: 16 }) {
      Text('üë§').fontSize(56)
      Text('ÁôªÂΩïÂêé‰∫´ÂèóÂÆåÊï¥ÂäüËÉΩ')
        .fontSize(16)
        .fontColor(AppColors.TEXT_SECONDARY)
      Button('ÁôªÂΩï / Ê≥®ÂÜå')
        .width(160)
        .height(44)
        .borderRadius(22)
        .backgroundColor(AppColors.PRIMARY)
        .fontColor('#FFFFFF')
        .fontSize(16)
        .onClick(() => {
          router.pushUrl({ url: `pages/${RouteConstants.LOGIN}` });
        })
    }
    .width('100%')
    .height('60%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  UserInfoSection() {
    Column({ space: 8 }) {
      // Â§¥ÂÉè
      if (this.userDetail?.avatarUrl) {
        Image(this.userDetail.avatarUrl)
          .width(80)
          .height(80)
          .borderRadius(40)
          .objectFit(ImageFit.Cover)
      } else {
        Text('üë§')
          .fontSize(40)
          .width(80)
          .height(80)
          .textAlign(TextAlign.Center)
          .backgroundColor('#F1F5F9')
          .borderRadius(40)
      }

      // Áî®Êà∑Âêç
      Text(this.userDetail?.name || this.currentUser?.userName || 'Áî®Êà∑')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TEXT_PRIMARY)

      // ÁÆÄ‰ªã
      if (this.userDetail?.bio) {
        Text(this.userDetail.bio)
          .fontSize(14)
          .fontColor(AppColors.TEXT_SECONDARY)
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .padding({ left: 32, right: 32 })
      }

      // ÂΩìÂâçÂüéÂ∏Ç
      if (this.userDetail?.currentCity) {
        Row({ space: 4 }) {
          Text('üìç')
            .fontSize(14)
          Text(`${this.userDetail.currentCity}${this.userDetail.currentCountry ? ', ' + this.userDetail.currentCountry : ''}`)
            .fontSize(14)
            .fontColor(AppColors.TEXT_SECONDARY)
        }
      }

      // ÁºñËæëÊåâÈíÆ
      Button('ÁºñËæëËµÑÊñô')
        .height(34)
        .fontSize(14)
        .borderRadius(17)
        .backgroundColor('transparent')
        .fontColor(AppColors.PRIMARY)
        .borderWidth(1)
        .borderColor(AppColors.PRIMARY)
        .margin({ top: 4 })
        .onClick(() => {
          router.pushUrl({ url: `pages/${RouteConstants.PROFILE_EDIT}` });
        })
    }
    .width('100%')
    .padding({ top: 32, bottom: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  StatsSection() {
    Row() {
      this.StatItem(this.userDetail!.stats.countriesVisited.toString(), 'ÂõΩÂÆ∂')
      Divider().vertical(true).height(32).color(AppColors.DIVIDER)
      this.StatItem(this.userDetail!.stats.citiesVisited.toString(), 'ÂüéÂ∏Ç')
      Divider().vertical(true).height(32).color(AppColors.DIVIDER)
      this.StatItem(this.userDetail!.stats.totalTrips.toString(), 'Ë°åÁ®ã')
      Divider().vertical(true).height(32).color(AppColors.DIVIDER)
      this.StatItem(this.userDetail!.stats.totalDays.toString(), 'Â§©Êï∞')
    }
    .width('100%')
    .padding({ top: 16, bottom: 16 })
    .margin({ left: 16, right: 16, bottom: 16 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .borderRadius(12)
    .justifyContent(FlexAlign.SpaceEvenly)
  }

  @Builder
  StatItem(value: string, label: string) {
    Column({ space: 4 }) {
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.PRIMARY)
      Text(label)
        .fontSize(12)
        .fontColor(AppColors.TEXT_SECONDARY)
    }
  }

  @Builder
  MenuSection() {
    Column() {
      this.MenuItem('üìã', 'ÊàëÁöÑÊóÖË°åËÆ°Âàí', () => {
        router.pushUrl({ url: `pages/${RouteConstants.TRAVEL_PLAN}` });
      })
      this.MenuItem('üéâ', 'ÊàëÁöÑËÅö‰ºö', () => {
        router.pushUrl({ url: `pages/${RouteConstants.MY_MEETUPS}` });
      })
      this.MenuItem('‚ù§Ô∏è', 'Êî∂Ëóè', () => {
        router.pushUrl({ url: `pages/${RouteConstants.FAVORITES}` });
      })
      this.MenuItem('üéØ', 'ÊäÄËÉΩ‰∏éÂÖ¥Ë∂£', () => {
        router.pushUrl({ url: `pages/${RouteConstants.EDIT_SKILLS}` });
      })
      this.MenuItem('üîó', 'Á§æ‰∫§ÈìæÊé•', () => {
        router.pushUrl({ url: `pages/${RouteConstants.EDIT_SOCIAL_LINKS}` });
      })
      this.MenuItem('üîî', 'ÈÄöÁü•ËÆæÁΩÆ', () => {
        router.pushUrl({ url: `pages/${RouteConstants.NOTIFICATIONS}` });
      })
      this.MenuItem('üìÑ', 'ÊúçÂä°Êù°Ê¨æ', () => {
        router.pushUrl({ url: `pages/${RouteConstants.TERMS_OF_SERVICE}` });
      })
      this.MenuItem('üìñ', 'Á§æÂå∫ÂáÜÂàô', () => {
        router.pushUrl({ url: `pages/${RouteConstants.COMMUNITY_GUIDELINES}` });
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16 })
    .backgroundColor(AppColors.CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
  }

  @Builder
  MenuItem(icon: string, title: string, onClick: () => void) {
    Row() {
      Text(icon)
        .fontSize(20)
        .width(36)
      Text(title)
        .fontSize(15)
        .fontColor(AppColors.TEXT_PRIMARY)
        .layoutWeight(1)
      SymbolGlyph($r('sys.symbol.chevron_right'))
        .fontSize(16)
        .fontColor([AppColors.TEXT_TERTIARY])
    }
    .width('100%')
    .height(52)
    .padding({ left: 12, right: 12 })
    .onClick(onClick)
  }
}
